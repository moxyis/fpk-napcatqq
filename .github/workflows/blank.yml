name: è‡ªåŠ¨æ„å»ºFPKï¼ˆæ£€æµ‹Dockeré•œåƒæ›´æ–°ï¼‰

# è§¦å‘è§„åˆ™ï¼šæ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

# æƒé™é…ç½®ï¼ˆå…è®¸æäº¤ä»£ç ã€æ“ä½œReleaseã€æ‹‰å–/æ¨é€å…¶ä»–ä»“åº“ï¼‰
permissions:
  contents: write
  packages: read
  id-token: write
  actions: read

jobs:
  check-and-build-fpk:
    runs-on: ubuntu-latest
    env:
      # ========== æ ¸å¿ƒé…ç½®ï¼šä¿®æ”¹ä¸ºä½ çš„manifestå®é™…è·¯å¾„ ==========
      MANIFEST_PATH: "./fpk-napcatqq/manifest"  # ç¤ºä¾‹ï¼šfpk-napcatqqæ–‡ä»¶å¤¹ä¸‹çš„manifest
      # =========================================================
      DIGEST_PATH: "./docker-image-digest.txt"  # å“ˆå¸Œè®°å½•æ–‡ä»¶è·¯å¾„ï¼ˆå¯æŒ‰éœ€ä¿®æ”¹ï¼‰
      FPK_FOLDER: "./fpk-napcatqq"              # FPKæ‰“åŒ…æ–‡ä»¶å¤¹è·¯å¾„

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–fpk-napcatqqä»“åº“ä»£ç 
      - name: æ‹‰å–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ– + ä¸‹è½½ fnpack æ‰“åŒ…å·¥å…·
      - name: å®‰è£…ä¾èµ–å¹¶ä¸‹è½½fnpackå·¥å…·
        run: |
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y skopeo jq git
          
          # ä¸‹è½½å¹¶å®‰è£…fnpack
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          wget -O /usr/local/bin/fnpack ${FNPACK_URL}
          chmod +x /usr/local/bin/fnpack
          
          # éªŒè¯fnpackæ˜¯å¦å¯æ‰§è¡Œ
          if [ -x /usr/local/bin/fnpack ]; then
            echo "âœ… fnpack å®‰è£…æˆåŠŸï¼ˆå¯æ‰§è¡Œæ–‡ä»¶å·²å­˜åœ¨ï¼‰"
          else
            echo "âŒ fnpack å®‰è£…å¤±è´¥ï¼ˆæ–‡ä»¶ä¸å¯æ‰§è¡Œæˆ–ä¸å­˜åœ¨ï¼‰"
            ls -l /usr/local/bin/fnpack
            exit 1
          fi

      # æ­¥éª¤3ï¼šå®¹é”™å¤„ç†manifest/å“ˆå¸Œæ–‡ä»¶ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
      - name: æ£€æŸ¥å¹¶åˆå§‹åŒ–é…ç½®æ–‡ä»¶
        run: |
          # å¤„ç†manifestæ–‡ä»¶
          if [ ! -f "${{ env.MANIFEST_PATH }}" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°manifestæ–‡ä»¶ï¼ˆè·¯å¾„ï¼š${{ env.MANIFEST_PATH }}ï¼‰ï¼Œè‡ªåŠ¨åˆ›å»ºå¹¶åˆå§‹åŒ–ç‰ˆæœ¬ä¸º0.0.0"
            # åˆ›å»ºçˆ¶ç›®å½•ï¼ˆé¿å…è·¯å¾„ä¸å­˜åœ¨ï¼‰
            mkdir -p $(dirname "${{ env.MANIFEST_PATH }}")
            echo "version=0.0.0" > "${{ env.MANIFEST_PATH }}"
          else
            echo "âœ… manifestæ–‡ä»¶å·²å­˜åœ¨ï¼ˆè·¯å¾„ï¼š${{ env.MANIFEST_PATH }}ï¼‰"
            cat "${{ env.MANIFEST_PATH }}"  # è¾“å‡ºæ–‡ä»¶å†…å®¹ä¾¿äºæ’æŸ¥
          fi
          
          # å¤„ç†docker-image-digest.txtæ–‡ä»¶
          if [ ! -f "${{ env.DIGEST_PATH }}" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°docker-image-digest.txtæ–‡ä»¶ï¼ˆè·¯å¾„ï¼š${{ env.DIGEST_PATH }}ï¼‰ï¼Œè‡ªåŠ¨åˆ›å»ºç©ºæ–‡ä»¶"
            touch "${{ env.DIGEST_PATH }}"
          fi

      # æ­¥éª¤4ï¼šè¯»å–æœ¬åœ°é…ç½®ï¼ˆmanifestç‰ˆæœ¬+å“ˆå¸Œè®°å½•ï¼‰
      - name: è¯»å–æœ¬åœ°é…ç½®ï¼ˆç‰ˆæœ¬+å“ˆå¸Œï¼‰
        id: local-config
        run: |
          # è¯»å–manifestä¸­çš„versionï¼ˆå¼ºåˆ¶è¯»å–ï¼Œé¿å…ç©ºå€¼ï¼‰
          LOCAL_VERSION=$(grep -E '^version=' "${{ env.MANIFEST_PATH }}" | cut -d'=' -f2 || echo "0.0.0")
          
          # å¤„ç†è¯»å–åˆ°ç©ºå€¼çš„æƒ…å†µ
          if [ -z "${LOCAL_VERSION}" ]; then
            echo "âš ï¸ manifestä¸­versionå­—æ®µä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼0.0.0å¹¶æ›´æ–°æ–‡ä»¶"
            LOCAL_VERSION="0.0.0"
            sed -i "s|^version=.*|version=0.0.0|g" "${{ env.MANIFEST_PATH }}"
          fi
          
          # è¯»å–å“ˆå¸Œè®°å½•
          LOCAL_DIGEST=$(cat "${{ env.DIGEST_PATH }}" 2>/dev/null || echo "")
          
          echo "LOCAL_VERSION=${LOCAL_VERSION}" >> $GITHUB_OUTPUT
          echo "LOCAL_DIGEST=${LOCAL_DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… æœ¬åœ°è®°å½• - ç‰ˆæœ¬: ${LOCAL_VERSION}, å“ˆå¸Œ: ${LOCAL_DIGEST}"

      # æ­¥éª¤5ï¼šè¿œç¨‹è·å–Dockeré•œåƒæœ€æ–°ç‰ˆæœ¬+å“ˆå¸Œï¼ˆå¸¦é‡è¯•ï¼‰
      - name: è·å–è¿œç¨‹Dockeré•œåƒä¿¡æ¯
        id: remote-docker
        run: |
          DOCKER_REPO="mlikiowa/napcat-docker"
          
          # é‡è¯•æœºåˆ¶ï¼šæœ€å¤š3æ¬¡è·å–Dockeræ ‡ç­¾
          for i in {1..3}; do
            REMOTE_TAG=$(curl -sSL "https://hub.docker.com/v2/repositories/${DOCKER_REPO}/tags?page_size=1&ordering=last_updated" | jq -r '.results[0].name')
            if [ "${REMOTE_TAG}" != "null" ] && [ -n "${REMOTE_TAG}" ]; then
              break
            fi
            echo "âš ï¸ ç¬¬${i}æ¬¡è·å–Dockeræ ‡ç­¾å¤±è´¥ï¼Œé‡è¯•ä¸­..."
            sleep 2
          done
          
          # æœ€ç»ˆæ ¡éªŒæ ‡ç­¾
          if [ "${REMOTE_TAG}" = "null" ] || [ -z "${REMOTE_TAG}" ]; then
            echo "âŒ å¤šæ¬¡é‡è¯•åä»æ— æ³•è·å–Dockeré•œåƒæœ€æ–°æ ‡ç­¾"
            exit 1
          fi
          
          # è·å–é•œåƒå“ˆå¸Œï¼ˆå¸¦é‡è¯•ï¼‰
          for i in {1..3}; do
            REMOTE_DIGEST=$(skopeo inspect docker://${DOCKER_REPO}:${REMOTE_TAG} | jq -r '.Digest')
            if [ "${REMOTE_DIGEST}" != "null" ] && [ -n "${REMOTE_DIGEST}" ]; then
              break
            fi
            echo "âš ï¸ ç¬¬${i}æ¬¡è·å–Dockerå“ˆå¸Œå¤±è´¥ï¼Œé‡è¯•ä¸­..."
            sleep 2
          done
          
          if [ "${REMOTE_DIGEST}" = "null" ] || [ -z "${REMOTE_DIGEST}" ]; then
            echo "âŒ å¤šæ¬¡é‡è¯•åä»æ— æ³•è·å–Dockeré•œåƒå“ˆå¸Œ"
            exit 1
          fi
          
          echo "REMOTE_REPO=${DOCKER_REPO}" >> $GITHUB_OUTPUT
          echo "REMOTE_TAG=${REMOTE_TAG}" >> $GITHUB_OUTPUT
          echo "REMOTE_DIGEST=${REMOTE_DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… è¿œç¨‹é•œåƒ - ç‰ˆæœ¬: ${REMOTE_TAG}, å“ˆå¸Œ: ${REMOTE_DIGEST}"

      # æ­¥éª¤6ï¼šå¯¹æ¯”ç‰ˆæœ¬/å“ˆå¸Œï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
      - name: å¯¹æ¯”ç‰ˆæœ¬å’Œå“ˆå¸Œï¼ˆåˆ¤æ–­æ˜¯å¦æ›´æ–°ï¼‰
        id: check-update
        run: |
          if [ "${{ steps.local-config.outputs.LOCAL_VERSION }}" != "${{ steps.remote-docker.outputs.REMOTE_TAG }}" ] || [ "${{ steps.local-config.outputs.LOCAL_DIGEST }}" != "${{ steps.remote-docker.outputs.REMOTE_DIGEST }}" ]; then
            echo "NEED_UPDATE=true" >> $GITHUB_OUTPUT
            echo "ğŸ”” ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼Œè§¦å‘æ›´æ–°"
          else
            echo "NEED_UPDATE=false" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬/å“ˆå¸Œä¸€è‡´ï¼Œæ— éœ€æ›´æ–°"
          fi

      # æ­¥éª¤7ï¼šæ‰“åŒ…å‰æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆmanifest+å“ˆå¸Œï¼‰
      - name: æ‰“åŒ…å‰æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆmanifest+å“ˆå¸Œï¼‰
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        run: |
          # æ›´æ–°manifestçš„versionå­—æ®µï¼ˆéæ ¹ç›®å½•ï¼‰
          sed -i "s|^version=.*|version=${{ steps.remote-docker.outputs.REMOTE_TAG }}|g" "${{ env.MANIFEST_PATH }}"
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "${{ steps.remote-docker.outputs.REMOTE_DIGEST }}" > "${{ env.DIGEST_PATH }}"
          echo "âœ… å·²æ›´æ–°é…ç½®æ–‡ä»¶ï¼š"
          echo "  - manifestè·¯å¾„: ${{ env.MANIFEST_PATH }}"
          echo "  - æ–°ç‰ˆæœ¬å·: ${{ steps.remote-docker.outputs.REMOTE_TAG }}"

      # æ­¥éª¤8ï¼šæ‰§è¡Œfnpack buildæ‰“åŒ…FPK
      - name: æ‰§è¡Œfnpack buildæ‰“åŒ…FPK
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        run: |
          # å®šä¹‰æœ€ç»ˆFPKæ–‡ä»¶åï¼ˆç¬¦åˆReleaseè§„åˆ™ï¼‰
          FPK_FILENAME="fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk"
          
          # æ£€æŸ¥FPKæ‰“åŒ…æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
          if [ ! -d "${{ env.FPK_FOLDER }}" ]; then
            echo "âŒ æœªæ‰¾åˆ°FPKæ‰“åŒ…æ–‡ä»¶å¤¹ï¼ˆè·¯å¾„ï¼š${{ env.FPK_FOLDER }}ï¼‰"
            exit 1
          fi
          
          # è¿›å…¥æ–‡ä»¶å¤¹æ‰§è¡Œæ‰“åŒ…
          cd "${{ env.FPK_FOLDER }}"
          echo "ğŸ“ æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…ç”Ÿæˆçš„FPKæ–‡ä»¶
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -n1)
          if [ -n "${FPK_FILE}" ]; then
            # å¤åˆ¶å¹¶é‡å‘½ååˆ°æ ¹ç›®å½•ï¼ˆä¾¿äºåç»­æ¨é€/å‘å¸ƒï¼‰
            mv ./${FPK_FILE} ../${FPK_FILENAME}
            echo "âœ… FPKæ‰“åŒ…æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„ï¼š../${FPK_FILENAME}"
          else
            echo "âŒ æœªæ‰¾åˆ°fnpack buildç”Ÿæˆçš„FPKæ–‡ä»¶"
            ls -l  # è¾“å‡ºæ–‡ä»¶å¤¹å†…å®¹ä¾¿äºæ’æŸ¥
            exit 1
          fi

      # æ­¥éª¤9ï¼šæäº¤é…ç½®æ–‡ä»¶å˜æ›´åˆ°ä»“åº“
      - name: æäº¤é…ç½®æ–‡ä»¶å˜æ›´åˆ°ä»“åº“
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: æ›´æ–°åˆ°napcat-docker ${VERSION} (digest: ${DIGEST})"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          file_pattern: |
            ${{ env.MANIFEST_PATH }}
            ${{ env.DIGEST_PATH }}
        env:
          VERSION: ${{ steps.remote-docker.outputs.REMOTE_TAG }}
          DIGEST: ${{ steps.remote-docker.outputs.REMOTE_DIGEST }}

      # æ­¥éª¤10ï¼šæ¨é€FPKåˆ°FnDepotä»“åº“çš„fpk-napcatqqæ–‡ä»¶å¤¹
      - name: æ¨é€FPKæ–‡ä»¶åˆ°FnDepotä»“åº“
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        env:
          PAT: ${{ secrets.FNDEPOT_PAT }}
        run: |
          # å®šä¹‰æ–‡ä»¶å
          FPK_RELEASE_NAME="fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk"
          FPK_FNDEPOT_NAME="fpk-napcatqq.fpk"
          
          # å…‹éš†FnDepotä»“åº“
          git clone https://${PAT}@github.com/moxyis/FnDepot.git ./FnDepot
          
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p ./FnDepot/fpk-napcatqq
          
          # å¤åˆ¶æ–‡ä»¶
          cp ./${FPK_RELEASE_NAME} ./FnDepot/fpk-napcatqq/${FPK_FNDEPOT_NAME}
          
          # æäº¤å¹¶æ¨é€
          cd ./FnDepot
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ./fpk-napcatqq/${FPK_FNDEPOT_NAME}
          git commit -m "æ›´æ–°fpk-napcatqq.fpkåˆ°ç‰ˆæœ¬ ${{ steps.remote-docker.outputs.REMOTE_TAG }}"
          git push origin main
          echo "âœ… FPKå·²æ¨é€åˆ°FnDepot/fpk-napcatqq/ (å‘½åä¸º: ${FPK_FNDEPOT_NAME})"

      # æ­¥éª¤11ï¼šå‘å¸ƒåˆ°GitHub Releaseï¼ˆé€‚é…å‘½å/æ ‡é¢˜è§„åˆ™ï¼‰
      - name: å‘å¸ƒFPKåˆ°GitHub Release
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.remote-docker.outputs.REMOTE_TAG }}
          name: "fpk-napcatqq ${{ steps.remote-docker.outputs.REMOTE_TAG }}"  # Releaseæ ‡é¢˜è§„åˆ™
          body: |
            ### è‡ªåŠ¨æ„å»ºçš„FPKåŒ…
            - Dockeré•œåƒ: ${{ steps.remote-docker.outputs.REMOTE_REPO }}@${{ steps.remote-docker.outputs.REMOTE_DIGEST }}
            - Manifestç‰ˆæœ¬: ${{ steps.remote-docker.outputs.REMOTE_TAG }}
            - Manifestè·¯å¾„: ${{ env.MANIFEST_PATH }}
            - æ„å»ºå‘½ä»¤: fnpack buildï¼ˆè·¯å¾„ï¼š${{ env.FPK_FOLDER }}ï¼‰
            - å¹³å°æ¶æ„: linux-amd64
            - FnDepotæ–‡ä»¶å: fpk-napcatqq.fpk
          files: ./fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk  # Releaseæ–‡ä»¶å‘½åè§„åˆ™
          draft: false
          prerelease: false
