name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…napcat-dockerå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sed/skopeoï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed skopeo
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼‰
        id: local_ver
        run: |
          if [ -f "fpk-napcatqq/manifest" ]; then
            # å…¼å®¹version: / version=ã€ç©ºæ ¼ã€å¼•å·ã€vå‰ç¼€
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' fpk-napcatqq/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°fpk-napcatqq/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p fpk-napcatqq
            echo "version: 0.0.0" > fpk-napcatqq/manifest
            git add fpk-napcatqq/manifest
            git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi

      - name: 5. è·å–napcat-dockeræœ€æ–°ç‰ˆæœ¬å·ï¼ˆç²¾å‡†é€‚é…APIè¿”å›ï¼‰
        id: remote_ver
        run: |
          set -euo pipefail
          
          # å®šä¹‰Docker Hub APIåœ°å€
          DOCKER_HUB_API="https://hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          REMOTE_VERSION=""
          REMOTE_DIGEST=""
          
          # é‡è¯•3æ¬¡è·å–æœ‰æ•ˆç‰ˆæœ¬å·ï¼ˆåŸºäºå®é™…APIè¿”å›æ ¼å¼ï¼‰
          for i in {1..3}; do
            echo "ğŸ“¡ ç¬¬${i}æ¬¡å°è¯•è·å–Docker Hubæ ‡ç­¾åˆ—è¡¨..."
            
            # 1. è·å–å®Œæ•´æ ‡ç­¾æ•°æ®ï¼ˆpage_size=100ç¡®ä¿è·å–è¶³å¤Ÿå¤šæ ‡ç­¾ï¼‰
            TAG_DATA=$(curl -sSL --retry 3 --connect-timeout 15 --max-time 30 \
              -H "Accept: application/json" \
              "${DOCKER_HUB_API}?page_size=100&ordering=-last_updated")
            
            # 2. è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰æ ‡ç­¾åç§°ï¼ˆå…³é”®ï¼éªŒè¯ç­›é€‰é€»è¾‘ï¼‰
            echo "ğŸ” æ‰€æœ‰æ ‡ç­¾åç§°ï¼š"
            echo "$TAG_DATA" | jq -r '.results[].name'
            
            # 3. ç²¾å‡†ç­›é€‰ï¼šæå–å¸¦vå‰ç¼€çš„æ•°å­—ç‰ˆæœ¬å·ï¼ˆv4.9.81ã€v4.9.80ç­‰ï¼‰
            # æ­¥éª¤1ï¼šæå–æ‰€æœ‰élatestçš„æ ‡ç­¾
            # æ­¥éª¤2ï¼šç­›é€‰ä»¥vå¼€å¤´+æ•°å­—ç‰ˆæœ¬çš„æ ‡ç­¾
            # æ­¥éª¤3ï¼šå»é™¤vå‰ç¼€
            # æ­¥éª¤4ï¼šæŒ‰è¯­ä¹‰åŒ–ç‰ˆæœ¬æ’åºå–æœ€æ–°
            REMOTE_VERSION=$(echo "$TAG_DATA" | jq -r '.results[].name' \
              | grep -v -E '^latest$' \
              | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
              | sed 's/^v//' \
              | sort -V \
              | tail -n1)
            
            # 4. æ£€æŸ¥æ˜¯å¦è·å–åˆ°ç‰ˆæœ¬å·
            if [ -n "$REMOTE_VERSION" ] && [ "$REMOTE_VERSION" != "null" ]; then
              echo "âœ… ç¬¬${i}æ¬¡è·å–æˆåŠŸï¼Œæœ€æ–°ç‰ˆæœ¬å·ï¼š$REMOTE_VERSION"
              break
            fi
            
            echo "âš ï¸ ç¬¬${i}æ¬¡è·å–ç‰ˆæœ¬å·å¤±è´¥ï¼Œ3ç§’åé‡è¯•..."
            sleep 3
          done
          
          # 5. ç»ˆæå…œåº•ï¼ˆè‹¥ä»å¤±è´¥ï¼‰
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ æ‰€æœ‰å°è¯•å‡å¤±è´¥ï¼Œä½¿ç”¨å…œåº•ç‰ˆæœ¬ï¼š4.9.81"
            REMOTE_VERSION="4.9.81"
          fi
          
          # 6. è·å–è¯¥ç‰ˆæœ¬çš„é•œåƒå“ˆå¸Œï¼ˆå¸¦vå‰ç¼€çš„åŸå§‹æ ‡ç­¾ï¼‰
          ORIGINAL_TAG="v${REMOTE_VERSION}"
          echo "ğŸ“Œ è·å–åŸå§‹æ ‡ç­¾ ${ORIGINAL_TAG} çš„é•œåƒå“ˆå¸Œ..."
          for i in {1..3}; do
            # ä¼˜å…ˆç”¨skopeoè·å–å“ˆå¸Œ
            DIGEST_DATA=$(skopeo inspect --format '{{.Digest}}' docker://mlikiowa/napcat-docker:${ORIGINAL_TAG} 2>/dev/null)
            # å¤‡ç”¨ï¼šä»APIè¿”å›ä¸­æå–å“ˆå¸Œ
            if [ -z "$DIGEST_DATA" ] || [ "$DIGEST_DATA" = "<no value>" ]; then
              DIGEST_DATA=$(echo "$TAG_DATA" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
            fi
            if [ -n "$DIGEST_DATA" ] && [ "$DIGEST_DATA" != "null" ]; then
              REMOTE_DIGEST=$DIGEST_DATA
              break
            fi
            echo "âš ï¸ ç¬¬${i}æ¬¡è·å–å“ˆå¸Œå¤±è´¥ï¼Œé‡è¯•ä¸­..."
            sleep 2
          done
          
          # 7. å“ˆå¸Œå…œåº•
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ]; then
            echo "âŒ æœªè·å–åˆ°é•œåƒå“ˆå¸Œï¼Œä½¿ç”¨ç©ºå€¼"
            REMOTE_DIGEST=""
          fi
          
          # 8. è¾“å‡ºæœ€ç»ˆç»“æœ
          echo "âœ… è¿œç¨‹æœ€æ–°ç‰ˆæœ¬ï¼ˆå»vå‰ç¼€ï¼‰ï¼š$REMOTE_VERSION"
          echo "âœ… è¿œç¨‹åŸå§‹æ ‡ç­¾ï¼šv$REMOTE_VERSION"
          echo "âœ… è¿œç¨‹é•œåƒå“ˆå¸Œï¼š$REMOTE_DIGEST"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "arch=Linux-AMD64" >> $GITHUB_OUTPUT  # å›ºå®šæ¶æ„

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•ï¼ˆé¿å…ç‰ˆæœ¬å·ç›¸åŒä½†é•œåƒæ›´æ–°ï¼‰
        id: local_digest
        run: |
          if [ -f "docker-image-digest.txt" ]; then
            LOCAL_DIGEST=$(cat docker-image-digest.txt | xargs)
          else
            LOCAL_DIGEST=""
            touch docker-image-digest.txt
          fi
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT
          echo "æœ¬åœ°é•œåƒå“ˆå¸Œï¼š$LOCAL_DIGEST"

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ] && [ "${{ steps.local_digest.outputs.local_digest }}" = "${{ steps.remote_ver.outputs.remote_digest }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬+å“ˆå¸Œä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifestç‰ˆæœ¬å· + å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°manifestç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            fpk-napcatqq/manifest
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "${{ steps.remote_ver.outputs.remote_digest }}" > docker-image-digest.txt
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat fpk-napcatqq/manifest | grep -i version
          echo "âœ… é•œåƒå“ˆå¸Œå·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_digest }}"
          cat docker-image-digest.txt

          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/manifest docker-image-digest.txt

      - name: 9. æäº¤å¹¶æ¨é€manifest+å“ˆå¸Œå˜æ›´åˆ°å½“å‰ä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… manifest+å“ˆå¸Œå·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 11. è¿›å…¥napcat-dockerç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          # è¿›å…¥fpk-napcatqqç›®å½•
          cd fpk-napcatqq
          echo "ğŸš€ è¿›å…¥fpk-napcatqqç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          if [ -z "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            exit 1
          fi
          
          # æ‹¼æ¥å®Œæ•´è·¯å¾„
          FPK_FULL_PATH=$(pwd)/$FPK_FILE
          # å›ºå®šåç§°ï¼ˆæ¨FnDepotï¼‰
          FPK_FIXED_NAME="fpk-napcatqq.fpk"
          # å¸¦ç‰ˆæœ¬å·+æ¶æ„åç§°ï¼ˆä¼ Releaseï¼‰
          FPK_VERSION_NAME="fpk-napcatqq-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}.fpk"
          
          # å¤åˆ¶ä¸¤ä»½æ–‡ä»¶
          mv "$FPK_FULL_PATH" /tmp/$FPK_FIXED_NAME
          cp /tmp/$FPK_FIXED_NAME /tmp/$FPK_VERSION_NAME
          
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆï¼š"
          echo "  - å›ºå®šåç§°ï¼š/tmp/$FPK_FIXED_NAME"
          echo "  - ç‰ˆæœ¬+æ¶æ„åç§°ï¼š/tmp/$FPK_VERSION_NAME"
          echo "fpk_file=/tmp/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€fpkåˆ°FnDepotä»“åº“ + æ›´æ–°é…ç½®æ–‡ä»¶ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepotç›®æ ‡ç›®å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p /tmp/FnDepot/fpk-napcatqq
          
          # åˆ é™¤æ—§æ–‡ä»¶
          rm -f /tmp/FnDepot/fpk-napcatqq/fpk-napcatqq.fpk
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp ${{ steps.build_fpk.outputs.fpk_file }} /tmp/FnDepot/fpk-napcatqq/
          
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š/tmp/FnDepot/fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }}"
          ls -lh /tmp/FnDepot/fpk-napcatqq/

      - name: 14. æ›´æ–°FnDepotçš„fnpack.jsonä¸­napcat-dockerç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºfnpack.json
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-napcatqq": {"version": ""}}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶"
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·
          jq --arg ver "${{ steps.remote_ver.outputs.remote_version }}" \
            '.["fpk-napcatqq"].version = $ver' fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json

      - name: 15. æ›´æ–°FnDepotçš„README.mdä¸­napcat-dockerè¡¨æ ¼ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºREADME.md
          if [ ! -f "README.md" ]; then
            echo "# FnDepot\n\n| **NapCatQQ** | ${{ steps.remote_ver.outputs.remote_version }} | NapCatQQ/https://github.com/NapNeko/NapCatQQ |\n\nNapCatQQæ˜¯é€šè¿‡Github-Actionsè¿›è¡Œæ¯å¤©è‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°ç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“\nè„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-napcatqq" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶"
          else
            # ç²¾å‡†æ›´æ–°è¡¨æ ¼ç‰ˆæœ¬å·ï¼ˆå…¼å®¹ä¸åŒé“¾æ¥æ ¼å¼ï¼‰
            sed -i -E \
              "s/(\|\s*\*\*NapCatQQ\*\*\s*\|\s*)[0-9.]+\s*(\|\s*NapCatQQ\/.*\s*\|)/\1${{ steps.remote_ver.outputs.remote_version }}\2/g" \
              README.md
              
            echo "âœ… README.mdä¸­NapCatQQè¡¨æ ¼ç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          fi
          
          # è¾“å‡ºå…³é”®å†…å®¹
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 1 -B 1 -i "napcat" README.md

      - name: 16. æäº¤å¹¶æ¨é€æ‰€æœ‰å˜æ›´åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }} fnpack.json README.md
          
          # æäº¤å˜æ›´
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq"

      # ===================== ç¬¬äº”æ­¥ï¼šä¸Šä¼ FPKåˆ°å½“å‰ä»“åº“çš„GitHub Releases =====================
      - name: 17. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ FPKæ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "napcat-docker-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}"
          name: "napcat-docker v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## napcat-docker è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - åŸå§‹Dockeræ ‡ç­¾ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - é•œåƒå“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest }}
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq
          prerelease: false
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true  # è¦†ç›–åŒåæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
