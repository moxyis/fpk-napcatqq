name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…napcat-dockerå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    timeout-minutes: 15  # è¶…æ—¶ä¿æŠ¤ï¼ˆæ‰“åŒ…æµç¨‹è€—æ—¶è¾ƒé•¿ï¼‰
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          sudo apt update && sudo apt install -y \
            jq curl sed skopeo coreutils findutils  # è¡¥å……åŸºç¡€å·¥å…·
          # éªŒè¯ä¾èµ–å®‰è£…
          for tool in jq curl sed skopeo; do
            if ! command -v $tool &>/dev/null; then
              echo "âŒ $tool å®‰è£…å¤±è´¥"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      - name: 3. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global core.autocrlf false  # é¿å…æ¢è¡Œç¬¦é—®é¢˜
          git config --global pull.rebase false     # é¿å…rebaseå†²çª
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼‰
        id: local_ver
        run: |
          if [ -f "fpk-napcatqq/manifest" ]; then
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' fpk-napcatqq/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°fpk-napcatqq/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p fpk-napcatqq
            echo "version: 0.0.0" > fpk-napcatqq/manifest
            git add fpk-napcatqq/manifest
            git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          LOCAL_VERSION=$(sed -n '
            s/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p
            s/^[[:space:]]*"version"[[:space:]]*:[[:space:]]*//p
            s/^[[:space:]]*'"'"'version'"'"'[[:space:]]*:[[:space:]]*//p
          ' "$MANIFEST_PATH" | tr -d '"\'' ' | sed 's/^v//' | xargs || echo "0.0.0")
          
          # ç‰ˆæœ¬å·æ ¼å¼æ ¡éªŒ
          if ! echo "$LOCAL_VERSION" | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' >/dev/null; then
            echo "âš ï¸ æœ¬åœ°ç‰ˆæœ¬å·æ ¼å¼å¼‚å¸¸ï¼ˆ$LOCAL_VERSIONï¼‰ï¼Œé‡ç½®ä¸º0.0.0"
            LOCAL_VERSION="0.0.0"
          fi
          
          echo "âœ… æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

      # ===================== æ ¸å¿ƒä¿®æ”¹ï¼šä»…ç”¨æŒ‡å®šcurlå‘½ä»¤è·å–æœ€æ–°ç‰ˆæœ¬å· =====================
      - name: 5. ä»Docker HubåŸå§‹APIè·å–æœ€æ–°ç‰ˆæœ¬å·ï¼ˆæ— åˆ†é¡µ/æ— å…œåº•ï¼‰
        id: remote_ver
        run: |
          set -euo pipefail
          
          # ä»…ä½¿ç”¨æŒ‡å®šçš„curlå‘½ä»¤ï¼Œæ— é¢å¤–å‚æ•°
          API_URL="https://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          RAW_RESPONSE=$(curl -s "$API_URL")
          REMOTE_VERSION=""
          REMOTE_DIGEST=""
          TOTAL_TAGS=0
          TOTAL_PAGES=1
          
          echo "ğŸ“¡ ä»åŸå§‹APIå“åº”æå–ç‰ˆæœ¬å·..."
          
          # 1. ç»Ÿè®¡æ€»æ ‡ç­¾æ•°
          TOTAL_TAGS=$(echo "$RAW_RESPONSE" | jq -r '.count // 0')
          
          # 2. æå–æ‰€æœ‰æœ‰æ•ˆç‰ˆæœ¬æ ‡ç­¾ï¼ˆvX.Y.Zæ ¼å¼ï¼Œæ’é™¤æµ‹è¯•/å¼€å‘æ ‡ç­¾ï¼‰
          ALL_VALID_TAGS=$(echo "$RAW_RESPONSE" | jq -r '.results[] | .name' \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$|^test$' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$')
          
          # 3. æ— æœ‰æ•ˆæ ‡ç­¾åˆ™ç»ˆæ­¢æµç¨‹
          if [ -z "$ALL_VALID_TAGS" ]; then
            echo "âŒ æœªä»APIè·å–åˆ°ä»»ä½•æœ‰æ•ˆç‰ˆæœ¬æ ‡ç­¾ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          
          # 4. ä¼˜å…ˆç­›é€‰4.xç³»åˆ—æ ‡ç­¾ï¼ˆç¡®ä¿è·å–é«˜ç‰ˆæœ¬ï¼‰
          TARGET_TAGS=$(echo "$ALL_VALID_TAGS" | grep -E '^v4\.' || echo "$ALL_VALID_TAGS")
          
          # 5. ç‰ˆæœ¬å·æ•°å­—æ’åºï¼ˆè§£å†³4.17 vs 4.9.81é—®é¢˜ï¼‰
          SORTED_TAGS=$(echo "$TARGET_TAGS" | while read -r tag; do
            ver=${tag#v}
            if [[ "$ver" =~ ^[0-9]+\.[0-9]+$ ]]; then
              echo "$ver.0|$tag"  # è¡¥å…¨ä¸ºX.Y.Zæ ¼å¼
            else
              echo "$ver|$tag"
            fi
          done | sort -t. -k1,1n -k2,2n -k3,3n)
          
          # 6. å–æ’åºåçš„æœ€åä¸€ä¸ªæ ‡ç­¾ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
          LATEST_TAG=$(echo "$SORTED_TAGS" | tail -n1 | cut -d'|' -f2)
          REMOTE_VERSION="${LATEST_TAG#v}"
          
          echo "âœ… ç­›é€‰åˆ°æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾ï¼š$LATEST_TAG â†’ ç‰ˆæœ¬å·ï¼š$REMOTE_VERSION"
          
          # 7. æå–è¯¥æ ‡ç­¾çš„é•œåƒå“ˆå¸Œ
          REMOTE_DIGEST=$(echo "$RAW_RESPONSE" | jq -r --arg tag "$LATEST_TAG" \
            '.results[] | select(.name == $tag) | .images[0].digest // ""')
          
          # 8. å“ˆå¸Œå…œåº•ï¼ˆä»…å½“åŸå§‹å“åº”ä¸­æœªæ‰¾åˆ°æ—¶ï¼‰
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ]; then
            REMOTE_DIGEST=$(skopeo inspect --format '{{.Digest}}' \
              docker://mlikiowa/napcat-docker:${LATEST_TAG} 2>/dev/null || echo "")
          fi
          
          # è¾“å‡ºç»Ÿè®¡å’Œç»“æœ
          echo -e "\nğŸ“Š APIç»Ÿè®¡ï¼š"
          echo "   æ€»æ ‡ç­¾æ•°ï¼š$TOTAL_TAGS"
          echo "   è¯·æ±‚é¡µæ•°ï¼š$TOTAL_PAGES"
          echo "âœ… æœ€ç»ˆç‰ˆæœ¬å·ï¼š$REMOTE_VERSION"
          echo "âœ… é•œåƒå“ˆå¸Œï¼š${REMOTE_DIGEST:-"æœªè·å–åˆ°"}"
          
          # è¾“å‡ºå˜é‡ï¼ˆä¿æŒå’ŒåŸæµç¨‹å…¼å®¹ï¼‰
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "arch=Linux-AMD64" >> $GITHUB_OUTPUT
          echo "total_tags=$TOTAL_TAGS" >> $GITHUB_OUTPUT
          echo "total_pages=$TOTAL_PAGES" >> $GITHUB_OUTPUT

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•
        id: local_digest
        run: |
          set -euo pipefail
          DIGEST_FILE="docker-image-digest.txt"
          
          # åˆå§‹åŒ–å“ˆå¸Œæ–‡ä»¶
          [ ! -f "$DIGEST_FILE" ] && touch "$DIGEST_FILE"
          
          # è¯»å–å“ˆå¸Œï¼ˆå»ç©ºæ ¼ï¼‰
          LOCAL_DIGEST=$(cat "$DIGEST_FILE" | xargs || echo "")
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… æœ¬åœ°é•œåƒå“ˆå¸Œï¼š${LOCAL_DIGEST:-"ç©º"}"

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          set -euo pipefail
          LOCAL_VER="${{ steps.local_ver.outputs.local_version }}"
          REMOTE_VER="${{ steps.remote_ver.outputs.remote_version }}"
          LOCAL_DIG="${{ steps.local_digest.outputs.local_digest }}"
          REMOTE_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          echo -e "\nğŸ” ç‰ˆæœ¬æ¯”å¯¹ç»“æœï¼š"
          echo "   æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VER | è¿œç¨‹ç‰ˆæœ¬: $REMOTE_VER"
          echo "   æœ¬åœ°å“ˆå¸Œ: ${LOCAL_DIG:-"ç©º"} | è¿œç¨‹å“ˆå¸Œ: ${REMOTE_DIG:-"ç©º"}"
          
          # åˆ¤æ–­é€»è¾‘ï¼šç‰ˆæœ¬ä¸åŒ æˆ– ç‰ˆæœ¬ç›¸åŒä½†å“ˆå¸Œä¸åŒ
          if [ "$LOCAL_VER" != "$REMOTE_VER" ] || [ "$LOCAL_DIG" != "$REMOTE_DIG" ]; then
            echo "âœ… éœ€è¦æ›´æ–°ï¼ˆç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼‰"
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ— éœ€æ›´æ–°ï¼ˆç‰ˆæœ¬+å“ˆå¸Œä¸€è‡´ï¼‰"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifest+å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          MANIFEST_PATH="fpk-napcatqq/manifest"
          DIGEST_FILE="docker-image-digest.txt"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          NEW_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          # æ›´æ–°manifestç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.-]+)([\"']?)/\1\2${NEW_VER}\4/" \
            "$MANIFEST_PATH"
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "$NEW_DIG" > "$DIGEST_FILE"
          
          # éªŒè¯æ›´æ–°
          echo -e "\nâœ… æ›´æ–°ç»“æœéªŒè¯ï¼š"
          echo "   manifestç‰ˆæœ¬: $(grep -i version "$MANIFEST_PATH" | xargs)"
          echo "   å“ˆå¸Œè®°å½•: $(cat "$DIGEST_FILE" | xargs || echo "ç©º")"
          
          # æš‚å­˜å˜æ›´
          git add "$MANIFEST_PATH" "$DIGEST_FILE"

      - name: 9. æäº¤å¹¶æ¨é€manifest+å“ˆå¸Œå˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          COMMIT_MSG="chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)"
          
          # æäº¤ï¼ˆæ— å˜æ›´æ—¶ä¸æŠ¥é”™ï¼‰
          git commit -m "$COMMIT_MSG" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          git push origin HEAD:${{ github.ref_name }} || (
            echo "âš ï¸ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡" && 
            git pull --rebase origin ${{ github.ref_name }} && 
            git push origin HEAD:${{ github.ref_name }}
          )
          
          echo "âœ… manifest+å“ˆå¸Œå·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpack
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          FNPACK_PATH="/usr/local/bin/fnpack"
          
          # ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼‰
          curl -SL --retry 3 --connect-timeout 10 --max-time 30 \
            -o "$FNPACK_PATH" "$FNPACK_URL"
          
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x "$FNPACK_PATH"
          
          # éªŒè¯å®‰è£…
          if ! fnpack --version &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(fnpack --version | head -n1)"

      - name: 11. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          set -euo pipefail
          cd fpk-napcatqq
          
          # æ‰§è¡Œæ‰“åŒ…
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œfnpack build..."
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…æ–‡ä»¶ï¼ˆå…¼å®¹å¤šç§å‘½åï¼‰
          FPK_FILE=$(find . -name "*.fpk" -type f -print0 | xargs -0 ls -t | head -n1)
          if [ -z "$FPK_FILE" ] || [ ! -f "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            ls -la  # è¾“å‡ºç›®å½•å†…å®¹ä¾¿äºæ’æŸ¥
            exit 1
          fi
          
          # å®šä¹‰æ–‡ä»¶å
          FPK_FIXED_NAME="fpk-napcatqq.fpk"
          FPK_VERSION_NAME="fpk-napcatqq-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}.fpk"
          
          # å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p /tmp/fpk_build
          cp "$FPK_FILE" "/tmp/fpk_build/$FPK_FIXED_NAME"
          cp "/tmp/fpk_build/$FPK_FIXED_NAME" "/tmp/fpk_build/$FPK_VERSION_NAME"
          
          # éªŒè¯æ–‡ä»¶
          for FILE in "/tmp/fpk_build/$FPK_FIXED_NAME" "/tmp/fpk_build/$FPK_VERSION_NAME"; do
            if [ ! -f "$FILE" ]; then
              echo "âŒ æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼š$FILE"
              exit 1
            fi
            echo "âœ… ç”Ÿæˆæ–‡ä»¶ï¼š$FILE (å¤§å°: $(du -h "$FILE" | cut -f1))"
          done
          
          # è¾“å‡ºå˜é‡
          echo "fpk_file=/tmp/fpk_build/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/fpk_build/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€è‡³FnDepotä»“åº“ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          FnDepot_DIR="/tmp/FnDepot"
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf "$FnDepot_DIR"
          
          # å…‹éš†ä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
          git clone \
            "https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git" \
            "$FnDepot_DIR"
          
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°ï¼š$FnDepot_DIR"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepot
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          DEST_DIR="/tmp/FnDepot/fpk-napcatqq"
          mkdir -p "$DEST_DIR"
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -f "$DEST_DIR"/*.fpk
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp "${{ steps.build_fpk.outputs.fpk_file }}" "$DEST_DIR/"
          
          # éªŒè¯
          ls -lh "$DEST_DIR/"
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°FnDepotä»“åº“"

      - name: 14. æ›´æ–°FnDepotçš„fnpack.json
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          JSON_FILE="/tmp/FnDepot/fnpack.json"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          
          # åˆå§‹åŒ–JSONæ–‡ä»¶
          if [ ! -f "$JSON_FILE" ]; then
            echo '{}' > "$JSON_FILE"
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆç¡®ä¿ç»“æ„æ­£ç¡®ï¼‰
          jq --arg ver "$NEW_VER" \
            '.["fpk-napcatqq"] = (.["fpk-napcatqq"] // {}) | .["fpk-napcatqq"].version = $ver' \
            "$JSON_FILE" > "$JSON_FILE.tmp" && mv "$JSON_FILE.tmp" "$JSON_FILE"
          
          # éªŒè¯
          echo "âœ… fnpack.jsonæ›´æ–°åå†…å®¹ï¼š"
          cat "$JSON_FILE"

      - name: 15. æ›´æ–°FnDepotçš„README.mdï¼ˆä¿®å¤EOF+æ–°æ ¼å¼ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          README_FILE="/tmp/FnDepot/README.md"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          TARGET_LINK="NapNeko/https://github.com/NapNeko/NapCatQQ/"
          
          # åˆå§‹åŒ–READMEï¼ˆæ”¹ç”¨é€è¡Œechoé¿å…EOFè§£æé”™è¯¯ï¼‰
          if [ ! -f "$README_FILE" ]; then
            echo "# FnDepot" > "$README_FILE"
            echo "" >> "$README_FILE"
            echo "| **NapCatQQ** | $NEW_VER | $TARGET_LINK |" >> "$README_FILE"
            echo "" >> "$README_FILE"
            echo "NapCatQQæ˜¯é€šè¿‡Github-Actionsè¿›è¡Œæ¯å¤©è‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°NapCatQQç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“ï¼Œä¸Šæ–¹çš„åº”ç”¨æ¸…å•çš„NapCatQQå¯¹åº”ç‰ˆæœ¬å·æš‚æ—¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°" >> "$README_FILE"
            echo "è„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-napcatqq" >> "$README_FILE"
            echo "âœ… åˆ›å»ºé»˜è®¤README.mdï¼ˆæ–°æ ¼å¼ï¼‰"
          else
            # å…³é”®ä¿®å¤ï¼šæ”¹ç”¨#ä½œä¸ºsedåˆ†éš”ç¬¦ï¼Œé¿å…/å†²çªï¼›é€‚é…æ–°é“¾æ¥æ ¼å¼
            sed -i -E \
              "s#(\|\s*\*\*?NapCatQQ\*\*?\s*\|\s*)[0-9.]+\s*(\|\s*${TARGET_LINK}\s*\|)#\1${NEW_VER}\2#g" \
              "$README_FILE"
            echo "âœ… README.mdç‰ˆæœ¬å·å·²æ›´æ–°ä¸ºï¼š$NEW_VER"
          fi
          
          # è¾“å‡ºå…³é”®å†…å®¹éªŒè¯
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 2 -B 1 "NapCatQQ" "$README_FILE"

      - name: 16. æäº¤å¹¶æ¨é€FnDepotå˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/ fnpack.json README.md
          
          # æäº¤
          COMMIT_MSG="chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)"
          git commit -m "$COMMIT_MSG" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          git push origin main || (
            echo "âš ï¸ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œé‡è¯•" && 
            git pull --rebase origin main && 
            git push origin main
          )
          
          echo "âœ… FnDepotä»“åº“æ›´æ–°å®Œæˆï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq"

      # ===================== ç¬¬äº”æ­¥ï¼šåˆ›å»ºGitHub Release =====================
      - name: 17. åˆ›å»ºReleaseå¹¶ä¸Šä¼ FPK
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "napcat-docker-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}"
          name: "napcat-docker v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## napcat-docker è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - åŸå§‹Dockeræ ‡ç­¾ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - é•œåƒå“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest || 'æœªè·å–åˆ°' }}
            - APIç»Ÿè®¡ï¼šå…±è·å– ${{ steps.remote_ver.outputs.total_pages }} é¡µï¼Œ${{ steps.remote_ver.outputs.total_tags }} ä¸ªæ ‡ç­¾
            - APIåœ°å€ï¼šhttps://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq
          prerelease: false
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true  # è¦†ç›–åŒåæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== ç¬¬å…­æ­¥ï¼šå¼‚å¸¸å¤„ç†ä¸æ—¥å¿—ä¸Šä¼  =====================
      - name: 18. ä¸Šä¼ è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ github.run_id }}
          path: |
            fpk-napcatqq/manifest
            docker-image-digest.txt
            /tmp/fpk_build/*
            /tmp/FnDepot/README.md
            ${{ github.workspace }}/.git/logs/*
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©
