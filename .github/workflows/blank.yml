name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…fpk-napcatqqå¹¶æ›´æ–°ä»“åº“

# è§¦å‘è§„åˆ™ï¼šæ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

# æƒé™é…ç½®ï¼ˆå…è®¸æäº¤ä»£ç ã€æ“ä½œReleaseã€æ‹‰å–/æ¨é€å…¶ä»–ä»“åº“ï¼‰
permissions:
  contents: write
  packages: read
  id-token: write
  actions: read

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–fpk-napcatqqä»“åº“ä»£ç 
      - name: Checkout fpk-napcatqq Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ– + ä¸‹è½½ fnpack æ‰“åŒ…å·¥å…·
      - name: Install Dependencies & Fnpack
        run: |
          # å®‰è£…åŸºç¡€ä¾èµ–
          sudo apt-get update
          sudo apt-get install -y skopeo jq git
          
          # ä¸‹è½½å¹¶å®‰è£…fnpack
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          wget -O /usr/local/bin/fnpack ${FNPACK_URL}
          chmod +x /usr/local/bin/fnpack
          
          # éªŒè¯fnpack
          if fnpack --version 2>/dev/null; then
            echo "âœ… fnpack å®‰è£…æˆåŠŸ"
          else
            echo "âŒ fnpack å®‰è£…å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤3ï¼šè¯»å–æœ¬åœ°çº¯æ–‡æœ¬manifestå’Œå“ˆå¸Œè®°å½•
      - name: Read Local Config
        id: local-config
        run: |
          # è¯»å–çº¯æ–‡æœ¬manifestçš„version
          LOCAL_VERSION=$(grep -E '^version=' ./manifest | cut -d'=' -f2)
          if [ -z "${LOCAL_VERSION}" ]; then
            echo "âŒ æœªä»manifestè¯»å–åˆ°versionå­—æ®µ"
            exit 1
          fi
          
          # è¯»å–å“ˆå¸Œè®°å½•
          LOCAL_DIGEST=$(cat ./docker-image-digest.txt 2>/dev/null || echo "")
          
          echo "LOCAL_VERSION=${LOCAL_VERSION}" >> $GITHUB_OUTPUT
          echo "LOCAL_DIGEST=${LOCAL_DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… æœ¬åœ°è®°å½• - ç‰ˆæœ¬: ${LOCAL_VERSION}, å“ˆå¸Œ: ${LOCAL_DIGEST}"

      # æ­¥éª¤4ï¼šè¿œç¨‹è·å–Dockeré•œåƒæœ€æ–°ç‰ˆæœ¬+å“ˆå¸Œ
      - name: Get Remote Docker Info
        id: remote-docker
        run: |
          DOCKER_REPO="mlikiowa/napcat-docker"
          
          # è·å–æœ€æ–°æ ‡ç­¾
          REMOTE_TAG=$(curl -sSL "https://hub.docker.com/v2/repositories/${DOCKER_REPO}/tags?page_size=1&ordering=last_updated" | jq -r '.results[0].name')
          if [ "${REMOTE_TAG}" = "null" ] || [ -z "${REMOTE_TAG}" ]; then
            echo "âŒ æ— æ³•è·å–Dockeré•œåƒæœ€æ–°æ ‡ç­¾"
            exit 1
          fi
          
          # è·å–é•œåƒå“ˆå¸Œ
          REMOTE_DIGEST=$(skopeo inspect docker://${DOCKER_REPO}:${REMOTE_TAG} | jq -r '.Digest')
          if [ "${REMOTE_DIGEST}" = "null" ] || [ -z "${REMOTE_DIGEST}" ]; then
            echo "âŒ æ— æ³•è·å–Dockeré•œåƒå“ˆå¸Œ"
            exit 1
          fi
          
          echo "REMOTE_REPO=${DOCKER_REPO}" >> $GITHUB_OUTPUT
          echo "REMOTE_TAG=${REMOTE_TAG}" >> $GITHUB_OUTPUT
          echo "REMOTE_DIGEST=${REMOTE_DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… è¿œç¨‹é•œåƒ - ç‰ˆæœ¬: ${REMOTE_TAG}, å“ˆå¸Œ: ${REMOTE_DIGEST}"

      # æ­¥éª¤5ï¼šå¯¹æ¯”ç‰ˆæœ¬/å“ˆå¸Œï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
      - name: Check Update Need
        id: check-update
        run: |
          if [ "${{ steps.local-config.outputs.LOCAL_VERSION }}" != "${{ steps.remote-docker.outputs.REMOTE_TAG }}" ] || [ "${{ steps.local-config.outputs.LOCAL_DIGEST }}" != "${{ steps.remote-docker.outputs.REMOTE_DIGEST }}" ]; then
            echo "NEED_UPDATE=true" >> $GITHUB_OUTPUT
            echo "ğŸ”” ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼Œè§¦å‘æ›´æ–°"
          else
            echo "NEED_UPDATE=false" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬/å“ˆå¸Œä¸€è‡´ï¼Œæ— éœ€æ›´æ–°"
          fi

      # æ­¥éª¤6ï¼šå…ˆæ›´æ–°manifestå’Œå“ˆå¸Œè®°å½•ï¼ˆæ‰“åŒ…å‰æ›´æ–°ï¼‰
      - name: Update Config Files Before Build
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        run: |
          # æ›´æ–°çº¯æ–‡æœ¬manifestï¼ˆæ‰“åŒ…å‰å…ˆæ”¹ç‰ˆæœ¬å·ï¼‰
          sed -i "s|^version=.*|version=${{ steps.remote-docker.outputs.REMOTE_TAG }}|g" ./manifest
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "${{ steps.remote-docker.outputs.REMOTE_DIGEST }}" > ./docker-image-digest.txt
          echo "âœ… å·²æ›´æ–°manifestå’Œå“ˆå¸Œè®°å½•ï¼Œå½“å‰ç‰ˆæœ¬: ${{ steps.remote-docker.outputs.REMOTE_TAG }}"

      # æ­¥éª¤7ï¼šè¿›å…¥fpk-napcatqqæ–‡ä»¶å¤¹æ‰§è¡Œfnpack buildæ‰“åŒ…
      - name: Rebuild FPK with fnpack build
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        run: |
          # å®šä¹‰æœ€ç»ˆFPKæ–‡ä»¶åï¼ˆç¬¦åˆè§„åˆ™ï¼šfpk-napcatqq-ç‰ˆæœ¬å·-linux-amd64.fpkï¼‰
          FPK_FILENAME="fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk"
          
          # æ£€æŸ¥fpk-napcatqqæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
          if [ ! -d "./fpk-napcatqq" ]; then
            echo "âŒ æœªæ‰¾åˆ°fpk-napcatqqæ–‡ä»¶å¤¹"
            exit 1
          fi
          
          # è¿›å…¥fpk-napcatqqæ–‡ä»¶å¤¹æ‰§è¡Œfnpack build
          cd ./fpk-napcatqq
          fnpack build
          
          # éªŒè¯æ‰“åŒ…ç»“æœå¹¶æŒ‰è§„åˆ™é‡å‘½å
          # å…ˆæŸ¥æ‰¾æ‰“åŒ…ç”Ÿæˆçš„FPKæ–‡ä»¶ï¼ˆé€‚é…ä»»æ„.fpkåç¼€ï¼‰
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -n1)
          if [ -n "${FPK_FILE}" ]; then
            # é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶åå¹¶å¤åˆ¶åˆ°æ ¹ç›®å½•
            mv ./${FPK_FILE} ../${FPK_FILENAME}
            echo "âœ… FPKæ‰“åŒ…æˆåŠŸï¼Œæ–‡ä»¶å‘½åä¸º: ${FPK_FILENAME}"
          else
            echo "âŒ æœªæ‰¾åˆ°fnpack buildç”Ÿæˆçš„FPKæ–‡ä»¶"
            exit 1
          fi

      # æ­¥éª¤8ï¼šæäº¤fpk-napcatqqä»“åº“çš„é…ç½®å˜æ›´ï¼ˆmanifest+å“ˆå¸Œï¼‰
      - name: Commit Config Changes to fpk-napcatqq
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update to napcat-docker ${VERSION} (digest: ${DIGEST})"
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          file_pattern: |
            manifest
            docker-image-digest.txt
        env:
          VERSION: ${{ steps.remote-docker.outputs.REMOTE_TAG }}
          DIGEST: ${{ steps.remote-docker.outputs.REMOTE_DIGEST }}

      # æ­¥éª¤9ï¼šæ¨é€FPKåˆ°FnDepotä»“åº“çš„fpk-napcatqqæ–‡ä»¶å¤¹ï¼ˆç»Ÿä¸€å‘½åä¸ºfpk-napcatqq.fpkï¼‰
      - name: Push FPK to FnDepot Repository
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        env:
          PAT: ${{ secrets.FNDEPOT_PAT }}
        run: |
          # å®šä¹‰Releaseè§„åˆ™çš„æ–‡ä»¶åå’ŒFnDepotçš„ç›®æ ‡æ–‡ä»¶å
          FPK_RELEASE_NAME="fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk"
          FPK_FNDEPOT_NAME="fpk-napcatqq.fpk"
          
          # å…‹éš†FnDepotä»“åº“
          git clone https://${PAT}@github.com/moxyis/FnDepot.git ./FnDepot
          
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          mkdir -p ./FnDepot/fpk-napcatqq
          
          # å¤åˆ¶å¹¶æŒ‰FnDepotè¦æ±‚é‡å‘½å
          cp ./${FPK_RELEASE_NAME} ./FnDepot/fpk-napcatqq/${FPK_FNDEPOT_NAME}
          
          # æäº¤å¹¶æ¨é€
          cd ./FnDepot
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ./fpk-napcatqq/${FPK_FNDEPOT_NAME}
          git commit -m "update fpk-napcatqq.fpk to version ${{ steps.remote-docker.outputs.REMOTE_TAG }}"
          git push origin main
          echo "âœ… FPKå·²æ¨é€åˆ°FnDepot/fpk-napcatqq/ (å‘½åä¸º: ${FPK_FNDEPOT_NAME})"

      # æ­¥éª¤10ï¼šå‘å¸ƒåˆ°fpk-napcatqqä»“åº“çš„GitHub Releaseï¼ˆé€‚é…å‘½å/æ ‡é¢˜è§„åˆ™ï¼‰
      - name: Create GitHub Release
        if: steps.check-update.outputs.NEED_UPDATE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.remote-docker.outputs.REMOTE_TAG }}
          name: "fpk-napcatqq ${{ steps.remote-docker.outputs.REMOTE_TAG }}"  # Releaseæ ‡é¢˜è§„åˆ™
          body: |
            ### Auto-built FPK Package
            - Docker Image: ${{ steps.remote-docker.outputs.REMOTE_REPO }}@${{ steps.remote-docker.outputs.REMOTE_DIGEST }}
            - Manifest Version: ${{ steps.remote-docker.outputs.REMOTE_TAG }}
            - Build Command: fnpack build (in fpk-napcatqq folder)
            - Platform: linux-amd64
            - FPK File (FnDepot): fpk-napcatqq.fpk
          files: ./fpk-napcatqq-${{ steps.remote-docker.outputs.REMOTE_TAG }}-linux-amd64.fpk  # Releaseæ–‡ä»¶å‘½åè§„åˆ™
          draft: false
          prerelease: false
