name: 更新FnDepot的NapCatQQ版本号

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * *'  # 每日UTC 0点执行

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需写入权限推送变更
    steps:
      - name: 1. 检出FnDepot仓库
        uses: actions/checkout@v4
        with:
          repository: moxyis/FnDepot  # 目标仓库
          token: ${{ secrets.FnDepot_PAT }}  # 访问令牌
          path: FnDepot  # 检出到FnDepot目录

      - name: 2. 配置Git身份
        run: |
          cd FnDepot
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 3. 获取最新NapCatQQ版本号（从Docker Hub）
        id: get_version
        run: |
          # 调用Docker Hub API获取最新版本
          API_URL="https://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          RESPONSE=$(curl -sSL "$API_URL?page_size=100&ordering=-last_updated")
          
          # 筛选有效版本标签（v+数字格式）并取最新
          LATEST_VERSION=$(echo "$RESPONSE" | jq -r '.results[].name' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sed 's/^v//' \
            | sort -V \
            | tail -n1)
          
          # 兜底版本
          if [ -z "$LATEST_VERSION" ]; then
            LATEST_VERSION="4.9.81"
          fi
          
          echo "最新版本号：$LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: 4. 更新README.md中的表格版本号
        run: |
          cd FnDepot
          
          # 确保README.md存在
          if [ ! -f "README.md" ]; then
            # 创建默认README（含标准表格结构）
            cat > README.md << 'EOF'
# FnDepot

# | **名称**    | 版本号 | 仓库地址                                      | 类型   |
# |-------------|--------|-----------------------------------------------|--------|
# | **NapCatQQ** | 0.0.0  | https://github.com/NapNeko/NapCatQQ           | Docker |
# EOF
          # fi
          
          # 精准更新表格中的版本号（兼容现有结构）
          # 匹配表格行格式：| **NapCatQQ** | 任意版本 | 仓库地址 | 类型 |
          sed -i -E \
            "s/(\\|\\s*\\*\\*NapCatQQ\\*\\*\\s*\\|\\s*)[0-9.]+(\\s*\\|\\s*https:\\/\\/github\\.com\\/NapNeko\\/NapCatQQ\\s*\\|\\s*Docker\\s*\\|)/\1${{ steps.get_version.outputs.latest_version }}\2/" \
            README.md
          
          echo "更新后的表格内容："
          grep -A 1 -B 1 "NapCatQQ" README.md  # 验证更新结果

      - name: 5. 提交并推送变更
        run: |
          cd FnDepot
          
          # 检查是否有变更
          if git diff --quiet; then
            echo "无版本更新，无需提交"
            exit 0
          fi
          
          # 提交变更
          git add README.md
          git commit -m "chore: 更新NapCatQQ版本至${{ steps.get_version.outputs.latest_version }}"
          git push origin main
          
          echo "版本号已成功推送到FnDepot仓库"
