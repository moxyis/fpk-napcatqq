name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…napcat-dockerå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    timeout-minutes: 15  # è¶…æ—¶ä¿æŠ¤ï¼ˆæ‰“åŒ…æµç¨‹è€—æ—¶è¾ƒé•¿ï¼‰
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          sudo apt update && sudo apt install -y \
            jq curl sed skopeo coreutils findutils  # è¡¥å……åŸºç¡€å·¥å…·
          # éªŒè¯ä¾èµ–å®‰è£…
          for tool in jq curl sed skopeo; do
            if ! command -v $tool &>/dev/null; then
              echo "âŒ $tool å®‰è£…å¤±è´¥"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      - name: 3. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global core.autocrlf false  # é¿å…æ¢è¡Œç¬¦é—®é¢˜
          git config --global pull.rebase false     # é¿å…rebaseå†²çª
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼‰
        id: local_ver
        run: |
          set -euo pipefail
          MANIFEST_PATH="fpk-napcatqq/manifest"
          
          # åˆ›å»ºç›®å½•ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          mkdir -p "$(dirname "$MANIFEST_PATH")"
          
          # åˆå§‹åŒ–manifestï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "version: 0.0.0" > "$MANIFEST_PATH"
            echo "âš ï¸ åˆå§‹åŒ–manifestæ–‡ä»¶ï¼Œç‰ˆæœ¬å·ï¼š0.0.0"
          fi
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          LOCAL_VERSION=$(sed -n '
            s/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p
            s/^[[:space:]]*"version"[[:space:]]*:[[:space:]]*//p
            s/^[[:space:]]*'"'"'version'"'"'[[:space:]]*:[[:space:]]*//p
          ' "$MANIFEST_PATH" | tr -d '"\'' ' | sed 's/^v//' | xargs || echo "0.0.0")
          
          # ç‰ˆæœ¬å·æ ¼å¼æ ¡éªŒ
          if ! echo "$LOCAL_VERSION" | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' >/dev/null; then
            echo "âš ï¸ æœ¬åœ°ç‰ˆæœ¬å·æ ¼å¼å¼‚å¸¸ï¼ˆ$LOCAL_VERSIONï¼‰ï¼Œé‡ç½®ä¸º0.0.0"
            LOCAL_VERSION="0.0.0"
          fi
          
          echo "âœ… æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

      - name: 5. è°ƒç”¨Docker Hub V2 APIè·å–å®Œæ•´æ ‡ç­¾åˆ—è¡¨ï¼ˆä¿®å¤ç‰ˆæœ¬æ’åºï¼‰
        id: remote_ver
        run: |
          set -euo pipefail
          
          # æ ¸å¿ƒé…ç½®
          API_BASE_URL="https://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          ALL_TAGS=()
          NEXT_PAGE="$API_BASE_URL?page_size=100&ordering=-last_updated"
          MAX_PAGES=20  # é™åˆ¶æœ€å¤§é¡µæ•°
          PAGE_COUNT=0
          REMOTE_VERSION="4.9.81"  # å…œåº•ç‰ˆæœ¬
          REMOTE_DIGEST=""
          
          echo "ğŸ“¡ å¼€å§‹è°ƒç”¨Docker Hub V2 APIè·å–æ ‡ç­¾..."
          
          # ===================== åˆ†é¡µè·å–æ‰€æœ‰æ ‡ç­¾ =====================
          while [ -n "$NEXT_PAGE" ] && [ "$NEXT_PAGE" != "null" ] && [ $PAGE_COUNT -lt $MAX_PAGES ]; do
            PAGE_COUNT=$((PAGE_COUNT + 1))
            echo "ğŸ”„ æ­£åœ¨è·å–ç¬¬${PAGE_COUNT}é¡µï¼š$NEXT_PAGE"
            
            # å¸¦é‡è¯•çš„APIè¯·æ±‚
            RESPONSE=$(curl -sSL \
              --retry 3 --retry-delay 5 \
              --connect-timeout 15 --max-time 30 \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$NEXT_PAGE" || echo '{"results": [], "next": null}')
            
            # æ£€æŸ¥å“åº”æœ‰æ•ˆæ€§
            if ! echo "$RESPONSE" | jq -e '.results' >/dev/null 2>&1; then
              echo "âš ï¸ ç¬¬${PAGE_COUNT}é¡µå“åº”æ— æ•ˆï¼Œç»ˆæ­¢åˆ†é¡µè¯·æ±‚"
              break
            fi
            
            # æå–å½“å‰é¡µæ ‡ç­¾
            PAGE_TAGS=$(echo "$RESPONSE" | jq -r '.results[].name' | grep -v '^$' | sort -u)
            
            # æ·»åŠ åˆ°æ•°ç»„
            while IFS= read -r tag; do
              [ -n "$tag" ] && ALL_TAGS+=("$tag")
            done <<< "$PAGE_TAGS"
            
            # è·å–ä¸‹ä¸€é¡µURLï¼ˆå¤„ç†è½¬ä¹‰ï¼‰
            NEXT_PAGE=$(echo "$RESPONSE" | jq -r '.next' | sed -e 's/\u0026/\&/g' -e 's/^null$//')
            
            echo "âœ… ç¬¬${PAGE_COUNT}é¡µè·å–åˆ° $(echo "$PAGE_TAGS" | wc -l) ä¸ªæœ‰æ•ˆæ ‡ç­¾"
          done
          
          # ===================== å¤„ç†æ ‡ç­¾æ•°æ®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç‰ˆæœ¬æ’åºï¼‰ =====================
          # å»é‡
          UNIQUE_TAGS=($(printf "%s\n" "${ALL_TAGS[@]}" | sort -u))
          echo -e "\nğŸ“Š APIç»Ÿè®¡ï¼š"
          echo "   æ€»é¡µæ•°ï¼š$PAGE_COUNT"
          echo "   å»é‡åæ ‡ç­¾æ•°ï¼š${#UNIQUE_TAGS[@]}"
          echo "   æ ‡ç­¾åˆ—è¡¨ï¼š${UNIQUE_TAGS[*]}"
          
          # ç­›é€‰æœ‰æ•ˆç‰ˆæœ¬æ ‡ç­¾ï¼ˆvX.Y.Z æ ¼å¼ï¼‰
          VERSION_TAGS=($(printf "%s\n" "${UNIQUE_TAGS[@]}" \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$|^test$' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sed 's/^v//'))
          
          # æ ¸å¿ƒä¿®å¤ï¼šè‡ªå®šä¹‰ç‰ˆæœ¬æ’åºï¼ˆè§£å†³4.9.81 < 4.17çš„é—®é¢˜ï¼‰
          # æ­¥éª¤1ï¼šå°†ç‰ˆæœ¬å·è¡¥å…¨ä¸ºX.Y.Zæ ¼å¼ï¼ˆå¦‚4.17 â†’ 4.17.0ï¼Œ4.9.81 â†’ 4.9.81ï¼‰
          # æ­¥éª¤2ï¼šæŒ‰æ•°å­—åˆ†æ®µæ’åºï¼ˆä¸»ç‰ˆæœ¬â†’æ¬¡ç‰ˆæœ¬â†’è¡¥ä¸ç‰ˆæœ¬ï¼‰
          SORTED_VERSIONS=$(printf "%s\n" "${VERSION_TAGS[@]}" | while read -r ver; do
            # è¡¥å…¨ç‰ˆæœ¬å·ä¸º3æ®µ
            if [[ "$ver" =~ ^[0-9]+\.[0-9]+$ ]]; then
              echo "$ver.0"
            else
              echo "$ver"
            fi
          done | sort -t. -k1,1n -k2,2n -k3,3n)
          
          # æ­¥éª¤3ï¼šè¿˜åŸåŸå§‹ç‰ˆæœ¬æ ¼å¼ï¼ˆå»æ‰è¡¥å…¨çš„.0ï¼‰
          FINAL_SORTED=()
          while read -r sorted_ver; do
            # å»æ‰æœ«å°¾çš„.0ï¼ˆä»…å½“æ˜¯è¡¥å…¨çš„æƒ…å†µï¼‰
            if [[ "$sorted_ver" =~ ^([0-9]+\.[0-9]+)\.0$ ]]; then
              FINAL_SORTED+=("${BASH_REMATCH[1]}")
            else
              FINAL_SORTED+=("$sorted_ver")
            fi
          done <<< "$SORTED_VERSIONS"
          
          # æ­¥éª¤4ï¼šè·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆæ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ï¼‰
          if [ ${#FINAL_SORTED[@]} -gt 0 ]; then
            REMOTE_VERSION="${FINAL_SORTED[-1]}"
            echo "âœ… ä¿®å¤æ’åºåç­›é€‰åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
            echo "   æ’åºå‰ç‰ˆæœ¬åˆ—è¡¨ï¼š${VERSION_TAGS[*]}"
            echo "   æ’åºåç‰ˆæœ¬åˆ—è¡¨ï¼š${FINAL_SORTED[*]}"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆç‰ˆæœ¬ï¼Œä½¿ç”¨å…œåº•ç‰ˆæœ¬ï¼š$REMOTE_VERSION"
          fi
          
          # ===================== è·å–é•œåƒå“ˆå¸Œ =====================
          ORIGINAL_TAG="v${REMOTE_VERSION}"
          echo -e "\nğŸ“Œ è·å–æ ‡ç­¾ [$ORIGINAL_TAG] çš„é•œåƒå“ˆå¸Œ..."
          
          # 1. ä»åˆ†é¡µæ•°æ®ä¸­æŸ¥æ‰¾
          TAG_DIGEST=$(echo "$RESPONSE" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
          
          # 2. å•ç‹¬è¯·æ±‚æ ‡ç­¾è¯¦æƒ…
          if [ -z "$TAG_DIGEST" ] || [ "$TAG_DIGEST" = "null" ]; then
            TAG_DETAIL=$(curl -sSL --retry 2 --connect-timeout 10 \
              "$API_BASE_URL?page_size=10&name=${ORIGINAL_TAG}")
            TAG_DIGEST=$(echo "$TAG_DETAIL" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
          fi
          
          # 3. skopeoå…œåº•
          if [ -z "$TAG_DIGEST" ] || [ "$TAG_DIGEST" = "null" ]; then
            TAG_DIGEST=$(skopeo inspect --format '{{.Digest}}' \
              docker://mlikiowa/napcat-docker:${ORIGINAL_TAG} 2>/dev/null || echo "")
          fi
          
          # æœ€ç»ˆå¤„ç†
          REMOTE_DIGEST=${TAG_DIGEST:-""}
          echo "âœ… é•œåƒå“ˆå¸Œï¼š${REMOTE_DIGEST:-"æœªè·å–åˆ°"}"
          
          # ===================== è¾“å‡ºå˜é‡ =====================
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "arch=Linux-AMD64" >> $GITHUB_OUTPUT
          echo "total_tags=${#UNIQUE_TAGS[@]}" >> $GITHUB_OUTPUT
          echo "total_pages=$PAGE_COUNT" >> $GITHUB_OUTPUT

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•
        id: local_digest
        run: |
          set -euo pipefail
          DIGEST_FILE="docker-image-digest.txt"
          
          # åˆå§‹åŒ–å“ˆå¸Œæ–‡ä»¶
          [ ! -f "$DIGEST_FILE" ] && touch "$DIGEST_FILE"
          
          # è¯»å–å“ˆå¸Œï¼ˆå»ç©ºæ ¼ï¼‰
          LOCAL_DIGEST=$(cat "$DIGEST_FILE" | xargs || echo "")
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… æœ¬åœ°é•œåƒå“ˆå¸Œï¼š${LOCAL_DIGEST:-"ç©º"}"

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          set -euo pipefail
          LOCAL_VER="${{ steps.local_ver.outputs.local_version }}"
          REMOTE_VER="${{ steps.remote_ver.outputs.remote_version }}"
          LOCAL_DIG="${{ steps.local_digest.outputs.local_digest }}"
          REMOTE_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          echo -e "\nğŸ” ç‰ˆæœ¬æ¯”å¯¹ç»“æœï¼š"
          echo "   æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VER | è¿œç¨‹ç‰ˆæœ¬: $REMOTE_VER"
          echo "   æœ¬åœ°å“ˆå¸Œ: ${LOCAL_DIG:-"ç©º"} | è¿œç¨‹å“ˆå¸Œ: ${REMOTE_DIG:-"ç©º"}"
          
          # åˆ¤æ–­é€»è¾‘ï¼šç‰ˆæœ¬ä¸åŒ æˆ– ç‰ˆæœ¬ç›¸åŒä½†å“ˆå¸Œä¸åŒ
          if [ "$LOCAL_VER" != "$REMOTE_VER" ] || [ "$LOCAL_DIG" != "$REMOTE_DIG" ]; then
            echo "âœ… éœ€è¦æ›´æ–°ï¼ˆç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼‰"
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ— éœ€æ›´æ–°ï¼ˆç‰ˆæœ¬+å“ˆå¸Œä¸€è‡´ï¼‰"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifest+å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          MANIFEST_PATH="fpk-napcatqq/manifest"
          DIGEST_FILE="docker-image-digest.txt"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          NEW_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          # æ›´æ–°manifestç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.-]+)([\"']?)/\1\2${NEW_VER}\4/" \
            "$MANIFEST_PATH"
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "$NEW_DIG" > "$DIGEST_FILE"
          
          # éªŒè¯æ›´æ–°
          echo -e "\nâœ… æ›´æ–°ç»“æœéªŒè¯ï¼š"
          echo "   manifestç‰ˆæœ¬: $(grep -i version "$MANIFEST_PATH" | xargs)"
          echo "   å“ˆå¸Œè®°å½•: $(cat "$DIGEST_FILE" | xargs || echo "ç©º")"
          
          # æš‚å­˜å˜æ›´
          git add "$MANIFEST_PATH" "$DIGEST_FILE"

      - name: 9. æäº¤å¹¶æ¨é€manifest+å“ˆå¸Œå˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          COMMIT_MSG="chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)"
          
          # æäº¤ï¼ˆæ— å˜æ›´æ—¶ä¸æŠ¥é”™ï¼‰
          git commit -m "$COMMIT_MSG" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          git push origin HEAD:${{ github.ref_name }} || (
            echo "âš ï¸ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡" && 
            git pull --rebase origin ${{ github.ref_name }} && 
            git push origin HEAD:${{ github.ref_name }}
          )
          
          echo "âœ… manifest+å“ˆå¸Œå·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpack
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          FNPACK_PATH="/usr/local/bin/fnpack"
          
          # ä¸‹è½½ï¼ˆå¸¦é‡è¯•ï¼‰
          curl -SL --retry 3 --connect-timeout 10 --max-time 30 \
            -o "$FNPACK_PATH" "$FNPACK_URL"
          
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x "$FNPACK_PATH"
          
          # éªŒè¯å®‰è£…
          if ! fnpack --version &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(fnpack --version | head -n1)"

      - name: 11. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          set -euo pipefail
          cd fpk-napcatqq
          
          # æ‰§è¡Œæ‰“åŒ…
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œfnpack build..."
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
          FPK_FILE=$(find . -name "*.fpk" -type f -print0 | xargs -0 ls -t | head -n1)
          if [ -z "$FPK_FILE" ] || [ ! -f "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            ls -la  # è¾“å‡ºç›®å½•å†…å®¹ä¾¿äºæ’æŸ¥
            exit 1
          fi
          
          # å®šä¹‰æ–‡ä»¶å
          FPK_FIXED_NAME="fpk-napcatqq.fpk"
          FPK_VERSION_NAME="fpk-napcatqq-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}.fpk"
          
          # å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p /tmp/fpk_build
          cp "$FPK_FILE" "/tmp/fpk_build/$FPK_FIXED_NAME"
          cp "/tmp/fpk_build/$FPK_FIXED_NAME" "/tmp/fpk_build/$FPK_VERSION_NAME"
          
          # éªŒè¯æ–‡ä»¶
          for FILE in "/tmp/fpk_build/$FPK_FIXED_NAME" "/tmp/fpk_build/$FPK_VERSION_NAME"; do
            if [ ! -f "$FILE" ]; then
              echo "âŒ æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼š$FILE"
              exit 1
            fi
            echo "âœ… ç”Ÿæˆæ–‡ä»¶ï¼š$FILE (å¤§å°: $(du -h "$FILE" | cut -f1))"
          done
          
          # è¾“å‡ºå˜é‡
          echo "fpk_file=/tmp/fpk_build/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/fpk_build/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€è‡³FnDepotä»“åº“ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          FnDepot_DIR="/tmp/FnDepot"
          
          # æ¸…ç†æ—§ç›®å½•
          rm -rf "$FnDepot_DIR"
          
          # å…‹éš†ä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
          git clone \
            "https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git" \
            "$FnDepot_DIR"
          
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°ï¼š$FnDepot_DIR"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepot
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          DEST_DIR="/tmp/FnDepot/fpk-napcatqq"
          mkdir -p "$DEST_DIR"
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -f "$DEST_DIR"/*.fpk
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp "${{ steps.build_fpk.outputs.fpk_file }}" "$DEST_DIR/"
          
          # éªŒè¯
          ls -lh "$DEST_DIR/"
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°FnDepotä»“åº“"

      - name: 14. æ›´æ–°FnDepotçš„fnpack.json
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          JSON_FILE="/tmp/FnDepot/fnpack.json"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          
          # åˆå§‹åŒ–JSONæ–‡ä»¶
          if [ ! -f "$JSON_FILE" ]; then
            echo '{}' > "$JSON_FILE"
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆç¡®ä¿ç»“æ„æ­£ç¡®ï¼‰
          jq --arg ver "$NEW_VER" \
            '.["fpk-napcatqq"] = (.["fpk-napcatqq"] // {}) | .["fpk-napcatqq"].version = $ver' \
            "$JSON_FILE" > "$JSON_FILE.tmp" && mv "$JSON_FILE.tmp" "$JSON_FILE"
          
          # éªŒè¯
          echo "âœ… fnpack.jsonæ›´æ–°åå†…å®¹ï¼š"
          cat "$JSON_FILE"

      - name: 15. æ›´æ–°FnDepotçš„README.mdï¼ˆä¿®å¤EOF+æ–°æ ¼å¼ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          README_FILE="/tmp/FnDepot/README.md"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          TARGET_LINK="NapNeko/https://github.com/NapNeko/NapCatQQ/"
          
          # åˆå§‹åŒ–READMEï¼ˆæ”¹ç”¨é€è¡Œechoé¿å…EOFè§£æé”™è¯¯ï¼‰
          if [ ! -f "$README_FILE" ]; then
            echo "# FnDepot" > "$README_FILE"
            echo "" >> "$README_FILE"
            echo "| **NapCatQQ** | $NEW_VER | $TARGET_LINK |" >> "$README_FILE"
            echo "" >> "$README_FILE"
            echo "NapCatQQæ˜¯é€šè¿‡Github-Actionsè¿›è¡Œæ¯å¤©è‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°NapCatQQç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“ï¼Œä¸Šæ–¹çš„åº”ç”¨æ¸…å•çš„NapCatQQå¯¹åº”ç‰ˆæœ¬å·æš‚æ—¶ä¸ä¼šè‡ªåŠ¨æ›´æ–°" >> "$README_FILE"
            echo "è„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-napcatqq" >> "$README_FILE"
            echo "âœ… åˆ›å»ºé»˜è®¤README.mdï¼ˆæ–°æ ¼å¼ï¼‰"
          else
            # å…³é”®ä¿®å¤ï¼šæ”¹ç”¨#ä½œä¸ºsedåˆ†éš”ç¬¦ï¼Œé¿å…/å†²çªï¼›é€‚é…æ–°é“¾æ¥æ ¼å¼
            sed -i -E \
              "s#(\|\s*\*\*?NapCatQQ\*\*?\s*\|\s*)[0-9.]+\s*(\|\s*${TARGET_LINK}\s*\|)#\1${NEW_VER}\2#g" \
              "$README_FILE"
            echo "âœ… README.mdç‰ˆæœ¬å·å·²æ›´æ–°ä¸ºï¼š$NEW_VER"
          fi
          
          # è¾“å‡ºå…³é”®å†…å®¹éªŒè¯
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 2 -B 1 "NapCatQQ" "$README_FILE"

      - name: 16. æäº¤å¹¶æ¨é€FnDepotå˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/ fnpack.json README.md
          
          # æäº¤
          COMMIT_MSG="chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)"
          git commit -m "$COMMIT_MSG" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          git push origin main || (
            echo "âš ï¸ é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œé‡è¯•" && 
            git pull --rebase origin main && 
            git push origin main
          )
          
          echo "âœ… FnDepotä»“åº“æ›´æ–°å®Œæˆï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq"

      # ===================== ç¬¬äº”æ­¥ï¼šåˆ›å»ºGitHub Release =====================
      - name: 17. åˆ›å»ºReleaseå¹¶ä¸Šä¼ FPK
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "napcat-docker-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}"
          name: "napcat-docker v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## napcat-docker è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - åŸå§‹Dockeræ ‡ç­¾ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - é•œåƒå“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest || 'æœªè·å–åˆ°' }}
            - APIç»Ÿè®¡ï¼šå…±è·å– ${{ steps.remote_ver.outputs.total_pages }} é¡µï¼Œ${{ steps.remote_ver.outputs.total_tags }} ä¸ªæ ‡ç­¾
            - APIåœ°å€ï¼šhttps://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq
          prerelease: false
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true  # è¦†ç›–åŒåæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== ç¬¬å…­æ­¥ï¼šå¼‚å¸¸å¤„ç†ä¸æ—¥å¿—ä¸Šä¼  =====================
      - name: 18. ä¸Šä¼ è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ github.run_id }}
          path: |
            fpk-napcatqq/manifest
            docker-image-digest.txt
            /tmp/fpk_build/*
            /tmp/FnDepot/README.md
            ${{ github.workspace }}/.git/logs/*
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©
