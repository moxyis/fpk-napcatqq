name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…napcat-dockerå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sed/skopeoï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed skopeo
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼‰
        id: local_ver
        run: |
          if [ -f "fpk-napcatqq/manifest" ]; then
            # å…¼å®¹version: / version=ã€ç©ºæ ¼ã€å¼•å·ã€vå‰ç¼€
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' fpk-napcatqq/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°fpk-napcatqq/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p fpk-napcatqq
            echo "version: 0.0.0" > fpk-napcatqq/manifest
            git add fpk-napcatqq/manifest
            git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi

      - name: 5. è°ƒç”¨Docker Hub V2 APIè·å–å®Œæ•´æ ‡ç­¾åˆ—è¡¨
        id: remote_ver
        run: |
          set -euo pipefail
          
          # æ ¸å¿ƒé…ç½®
          API_BASE_URL="https://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          ALL_TAGS=()
          NEXT_PAGE="$API_BASE_URL?page_size=100&ordering=-last_updated"
          MAX_PAGES=20  # é™åˆ¶æœ€å¤§é¡µæ•°ï¼Œé¿å…æ— é™å¾ªç¯
          PAGE_COUNT=0
          REMOTE_VERSION=""
          REMOTE_DIGEST=""
          
          echo "ğŸ“¡ å¼€å§‹è°ƒç”¨Docker Hub V2 APIè·å–æ ‡ç­¾ï¼š$API_BASE_URL"
          
          # ===================== åˆ†é¡µè·å–æ‰€æœ‰æ ‡ç­¾ =====================
          while [ -n "$NEXT_PAGE" ] && [ "$NEXT_PAGE" != "null" ] && [ $PAGE_COUNT -lt $MAX_PAGES ]; do
            PAGE_COUNT=$((PAGE_COUNT + 1))
            echo "ğŸ”„ æ­£åœ¨è·å–ç¬¬${PAGE_COUNT}é¡µï¼ŒURLï¼š$NEXT_PAGE"
            
            # è°ƒç”¨V2 APIï¼ˆæ·»åŠ å¿…è¦çš„è¯·æ±‚å¤´ï¼‰
            RESPONSE=$(curl -sSL --retry 3 --connect-timeout 15 --max-time 30 \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              "$NEXT_PAGE")
            
            # æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
            if ! echo "$RESPONSE" | jq -e '.results' >/dev/null 2>&1; then
              echo "âš ï¸ ç¬¬${PAGE_COUNT}é¡µå“åº”æ— æ•ˆï¼Œå†…å®¹ï¼š$RESPONSE"
              break
            fi
            
            # æå–å½“å‰é¡µæ ‡ç­¾åç§°å¹¶å»é‡
            PAGE_TAGS=$(echo "$RESPONSE" | jq -r '.results[].name' | grep -v '^$' | sort -u)
            
            # å°†æ ‡ç­¾æ·»åŠ åˆ°æ•°ç»„
            while IFS= read -r tag; do
              if [ -n "$tag" ]; then
                ALL_TAGS+=("$tag")
              fi
            done <<< "$PAGE_TAGS"
            
            # è·å–ä¸‹ä¸€é¡µURLï¼ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ \u0026 = &ï¼‰
            NEXT_PAGE=$(echo "$RESPONSE" | jq -r '.next' | sed -e 's/\u0026/\&/g' -e 's/^null$//')
            
            echo "âœ… ç¬¬${PAGE_COUNT}é¡µè·å–åˆ°æœ‰æ•ˆæ ‡ç­¾ï¼š$(echo "$PAGE_TAGS" | wc -l) ä¸ª"
          done
          
          # å»é‡å¹¶æ•´ç†æ‰€æœ‰æ ‡ç­¾
          UNIQUE_TAGS=($(printf "%s\n" "${ALL_TAGS[@]}" | sort -u))
          echo -e "\nğŸ“Š APIè°ƒç”¨å®Œæˆï¼Œç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "   æ€»è¯·æ±‚é¡µæ•°ï¼š$PAGE_COUNT"
          echo "   å»é‡åæ ‡ç­¾æ€»æ•°ï¼š${#UNIQUE_TAGS[@]}"
          echo "   æ‰€æœ‰æ ‡ç­¾åˆ—è¡¨ï¼š"
          printf "   - %s\n" "${UNIQUE_TAGS[@]}"
          
          # ===================== ç­›é€‰æœ€æ–°ç‰ˆæœ¬å· =====================
          # ç­›é€‰è§„åˆ™ï¼šä»…ä¿ç•™å¸¦vå‰ç¼€çš„æ•°å­—ç‰ˆæœ¬ï¼ˆv4.9.81ã€v4.9.80ç­‰ï¼‰
          VERSION_TAGS=($(printf "%s\n" "${UNIQUE_TAGS[@]}" \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$|^test$' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sed 's/^v//' \
            | sort -V))
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆæ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ï¼‰
          if [ ${#VERSION_TAGS[@]} -gt 0 ]; then
            REMOTE_VERSION="${VERSION_TAGS[-1]}"
          else
            echo "âŒ æœªç­›é€‰åˆ°æœ‰æ•ˆç‰ˆæœ¬æ ‡ç­¾ï¼Œä½¿ç”¨å…œåº•ç‰ˆæœ¬"
            REMOTE_VERSION="4.9.81"
          fi
          
          # ===================== è·å–å¯¹åº”æ ‡ç­¾çš„é•œåƒå“ˆå¸Œ =====================
          ORIGINAL_TAG="v${REMOTE_VERSION}"
          echo -e "\nğŸ“Œ æŸ¥æ‰¾æ ‡ç­¾ [${ORIGINAL_TAG}] çš„é•œåƒå“ˆå¸Œ..."
          
          # 1. ä¼˜å…ˆä»å·²è·å–çš„APIæ•°æ®ä¸­åŒ¹é…å“ˆå¸Œ
          TAG_DIGEST=$(echo "$RESPONSE" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
          
          # 2. è‹¥æœªæ‰¾åˆ°ï¼Œå•ç‹¬è¯·æ±‚è¯¥æ ‡ç­¾çš„è¯¦æƒ…
          if [ -z "$TAG_DIGEST" ] || [ "$TAG_DIGEST" = "null" ]; then
            echo "âš ï¸ ä»åˆ†é¡µæ•°æ®ä¸­æœªæ‰¾åˆ°å“ˆå¸Œï¼Œå•ç‹¬è¯·æ±‚æ ‡ç­¾è¯¦æƒ…..."
            TAG_DETAIL_URL="${API_BASE_URL}?page_size=10&name=${ORIGINAL_TAG}"
            TAG_DETAIL=$(curl -sSL --retry 2 --connect-timeout 10 "$TAG_DETAIL_URL")
            TAG_DIGEST=$(echo "$TAG_DETAIL" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
          fi
          
          # 3. æœ€åç”¨skopeoå…œåº•è·å–
          if [ -z "$TAG_DIGEST" ] || [ "$TAG_DIGEST" = "null" ]; then
            echo "âš ï¸ APIæœªè¿”å›å“ˆå¸Œï¼Œä½¿ç”¨skopeoè·å–..."
            TAG_DIGEST=$(skopeo inspect --format '{{.Digest}}' docker://mlikiowa/napcat-docker:${ORIGINAL_TAG} 2>/dev/null)
          fi
          
          # å“ˆå¸Œå€¼å…œåº•å¤„ç†
          if [ -z "$TAG_DIGEST" ] || [ "$TAG_DIGEST" = "null" ] || [ "$TAG_DIGEST" = "<no value>" ]; then
            echo "âŒ æ— æ³•è·å–é•œåƒå“ˆå¸Œï¼Œä½¿ç”¨ç©ºå€¼"
            REMOTE_DIGEST=""
          else
            REMOTE_DIGEST="$TAG_DIGEST"
          fi
          
          # ===================== è¾“å‡ºæœ€ç»ˆç»“æœ =====================
          echo -e "\nâœ… æœ€ç»ˆè·å–ç»“æœï¼š"
          echo "   æœ€æ–°ç‰ˆæœ¬å·ï¼ˆå»vå‰ç¼€ï¼‰ï¼š$REMOTE_VERSION"
          echo "   Docker HubåŸå§‹æ ‡ç­¾ï¼š$ORIGINAL_TAG"
          echo "   é•œåƒå“ˆå¸Œï¼š$REMOTE_DIGEST"
          echo "   APIåœ°å€ï¼š$API_BASE_URL"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "arch=Linux-AMD64" >> $GITHUB_OUTPUT
          echo "total_tags=${#UNIQUE_TAGS[@]}" >> $GITHUB_OUTPUT
          echo "total_pages=$PAGE_COUNT" >> $GITHUB_OUTPUT

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•ï¼ˆé¿å…ç‰ˆæœ¬å·ç›¸åŒä½†é•œåƒæ›´æ–°ï¼‰
        id: local_digest
        run: |
          if [ -f "docker-image-digest.txt" ]; then
            LOCAL_DIGEST=$(cat docker-image-digest.txt | xargs)
          else
            LOCAL_DIGEST=""
            touch docker-image-digest.txt
          fi
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT
          echo "æœ¬åœ°é•œåƒå“ˆå¸Œï¼š$LOCAL_DIGEST"

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ] && [ "${{ steps.local_digest.outputs.local_digest }}" = "${{ steps.remote_ver.outputs.remote_digest }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬+å“ˆå¸Œä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifestç‰ˆæœ¬å· + å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°manifestç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            fpk-napcatqq/manifest
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "${{ steps.remote_ver.outputs.remote_digest }}" > docker-image-digest.txt
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat fpk-napcatqq/manifest | grep -i version
          echo "âœ… é•œåƒå“ˆå¸Œå·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_digest }}"
          cat docker-image-digest.txt

          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/manifest docker-image-digest.txt

      - name: 9. æäº¤å¹¶æ¨é€manifest+å“ˆå¸Œå˜æ›´åˆ°å½“å‰ä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… manifest+å“ˆå¸Œå·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 11. è¿›å…¥napcat-dockerç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          # è¿›å…¥fpk-napcatqqç›®å½•
          cd fpk-napcatqq
          echo "ğŸš€ è¿›å…¥fpk-napcatqqç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          if [ -z "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            exit 1
          fi
          
          # æ‹¼æ¥å®Œæ•´è·¯å¾„
          FPK_FULL_PATH=$(pwd)/$FPK_FILE
          # å›ºå®šåç§°ï¼ˆæ¨FnDepotï¼‰
          FPK_FIXED_NAME="fpk-napcatqq.fpk"
          # å¸¦ç‰ˆæœ¬å·+æ¶æ„åç§°ï¼ˆä¼ Releaseï¼‰
          FPK_VERSION_NAME="fpk-napcatqq-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}.fpk"
          
          # å¤åˆ¶ä¸¤ä»½æ–‡ä»¶
          mv "$FPK_FULL_PATH" /tmp/$FPK_FIXED_NAME
          cp /tmp/$FPK_FIXED_NAME /tmp/$FPK_VERSION_NAME
          
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆï¼š"
          echo "  - å›ºå®šåç§°ï¼š/tmp/$FPK_FIXED_NAME"
          echo "  - ç‰ˆæœ¬+æ¶æ„åç§°ï¼š/tmp/$FPK_VERSION_NAME"
          echo "fpk_file=/tmp/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€fpkåˆ°FnDepotä»“åº“ + æ›´æ–°é…ç½®æ–‡ä»¶ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepotç›®æ ‡ç›®å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p /tmp/FnDepot/fpk-napcatqq
          
          # åˆ é™¤æ—§æ–‡ä»¶
          rm -f /tmp/FnDepot/fpk-napcatqq/fpk-napcatqq.fpk
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp ${{ steps.build_fpk.outputs.fpk_file }} /tmp/FnDepot/fpk-napcatqq/
          
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š/tmp/FnDepot/fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }}"
          ls -lh /tmp/FnDepot/fpk-napcatqq/

      - name: 14. æ›´æ–°FnDepotçš„fnpack.jsonä¸­napcat-dockerç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºfnpack.json
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-napcatqq": {"version": ""}}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶"
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·
          jq --arg ver "${{ steps.remote_ver.outputs.remote_version }}" \
            '.["fpk-napcatqq"].version = $ver' fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json

      - name: 15. æ›´æ–°FnDepotçš„README.mdä¸­napcat-dockerè¡¨æ ¼ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºREADME.md
          if [ ! -f "README.md" ]; then
            echo "# FnDepot\n\n| **NapCatQQ** | ${{ steps.remote_ver.outputs.remote_version }} | NapCatQQ/https://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags |\n\nNapCatQQæ˜¯é€šè¿‡Github-Actionsè°ƒç”¨Docker Hub V2 APIè‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°ç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“\nè„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-napcatqq" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶"
          else
            # ç²¾å‡†æ›´æ–°è¡¨æ ¼ç‰ˆæœ¬å·ï¼ˆåŒ¹é…V2 APIé“¾æ¥ï¼‰
            sed -i -E \
              "s/(\|\s*\*\*NapCatQQ\*\*\s*\|\s*)[0-9.]+\s*(\|\s*NapCatQQ\/https:\/\/registry\.hub\.docker\.com\/v2\/repositories\/mlikiowa\/napcat-docker\/tags\s*\|)/\1${{ steps.remote_ver.outputs.remote_version }}\2/g" \
              README.md
              
            echo "âœ… README.mdä¸­NapCatQQè¡¨æ ¼ç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          fi
          
          # è¾“å‡ºå…³é”®å†…å®¹
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 1 -B 1 -i "napcat" README.md

      - name: 16. æäº¤å¹¶æ¨é€æ‰€æœ‰å˜æ›´åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }} fnpack.json README.md
          
          # æäº¤å˜æ›´ï¼ˆåŒ…å«APIç»Ÿè®¡ä¿¡æ¯ï¼‰
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }} (API: ${{ steps.remote_ver.outputs.total_tags }}æ ‡ç­¾/${{ steps.remote_ver.outputs.total_pages }}é¡µ)" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq"

      # ===================== ç¬¬äº”æ­¥ï¼šä¸Šä¼ FPKåˆ°å½“å‰ä»“åº“çš„GitHub Releases =====================
      - name: 17. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ FPKæ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "napcat-docker-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}"
          name: "napcat-docker v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## napcat-docker è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - åŸå§‹Dockeræ ‡ç­¾ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - é•œåƒå“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest }}
            - APIç»Ÿè®¡ï¼šå…±è·å– ${{ steps.remote_ver.outputs.total_pages }} é¡µï¼Œ${{ steps.remote_ver.outputs.total_tags }} ä¸ªæ ‡ç­¾
            - APIåœ°å€ï¼šhttps://registry.hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq
          prerelease: false
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true  # è¦†ç›–åŒåæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…napcat-dockerå¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“æ¨é€é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 3. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆjq/curl/sed/skopeoï¼‰
        run: |
          sudo apt update && sudo apt install -y jq curl sed skopeo
          echo "åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼‰
        id: local_ver
        run: |
          if [ -f "fpk-napcatqq/manifest" ]; then
            # å…¼å®¹version: / version=ã€ç©ºæ ¼ã€å¼•å·ã€vå‰ç¼€
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' fpk-napcatqq/manifest \
              | tr -d '"' | tr -d "'" | sed 's/^v//' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š$LOCAL_VERSION"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°fpk-napcatqq/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p fpk-napcatqq
            echo "version: 0.0.0" > fpk-napcatqq/manifest
            git add fpk-napcatqq/manifest
            git commit -m "chore: åˆå§‹åŒ–manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi

      - name: 5. è·å–napcat-dockeræ‰€æœ‰æ ‡ç­¾ï¼ˆåˆ†é¡µéå†ï¼‰+ æœ€æ–°ç‰ˆæœ¬å·
        id: remote_ver
        run: |
          set -euo pipefail
          
          # åˆå§‹åŒ–å˜é‡
          DOCKER_HUB_API="https://hub.docker.com/v2/repositories/mlikiowa/napcat-docker/tags"
          NEXT_PAGE="$DOCKER_HUB_API?page_size=100&ordering=-last_updated"
          ALL_TAGS=""
          REMOTE_VERSION=""
          REMOTE_DIGEST=""
          MAX_PAGES=10  # é™åˆ¶æœ€å¤§é¡µæ•°ï¼Œé¿å…æ— é™å¾ªç¯
          PAGE_COUNT=0
          
          echo "ğŸ“¡ å¼€å§‹åˆ†é¡µè·å–æ‰€æœ‰Docker Hubæ ‡ç­¾..."
          
          # ===================== æ ¸å¿ƒï¼šåˆ†é¡µéå†æ‰€æœ‰æ ‡ç­¾ =====================
          while [ -n "$NEXT_PAGE" ] && [ "$NEXT_PAGE" != "null" ] && [ $PAGE_COUNT -lt $MAX_PAGES ]; do
            PAGE_COUNT=$((PAGE_COUNT + 1))
            echo "ğŸ”„ è·å–ç¬¬${PAGE_COUNT}é¡µæ ‡ç­¾ï¼ŒURLï¼š$NEXT_PAGE"
            
            # è·å–å½“å‰é¡µæ•°æ®
            PAGE_DATA=$(curl -sSL --retry 3 --connect-timeout 15 --max-time 30 \
              -H "Accept: application/json" \
              "$NEXT_PAGE")
            
            # æå–å½“å‰é¡µæ ‡ç­¾åç§°
            PAGE_TAGS=$(echo "$PAGE_DATA" | jq -r '.results[].name')
            if [ -n "$PAGE_TAGS" ] && [ "$PAGE_TAGS" != "null" ]; then
              ALL_TAGS="$ALL_TAGS"$'\n'"$PAGE_TAGS"
              echo "âœ… ç¬¬${PAGE_COUNT}é¡µè·å–åˆ°æ ‡ç­¾ï¼š$(echo "$PAGE_TAGS" | wc -l) ä¸ª"
            fi
            
            # è·å–ä¸‹ä¸€é¡µURLï¼ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ \u0026 = &ï¼‰
            NEXT_PAGE=$(echo "$PAGE_DATA" | jq -r '.next' | sed 's/\u0026/\&/g')
          done
          
          # ===================== å¤„ç†æ‰€æœ‰æ ‡ç­¾ =====================
          echo -e "\nğŸ“Š æ€»å…±è·å–åˆ°æ ‡ç­¾æ•°é‡ï¼š$(echo "$ALL_TAGS" | grep -v '^$' | wc -l) ä¸ª"
          echo "ğŸ” æ‰€æœ‰æ ‡ç­¾åˆ—è¡¨ï¼š"
          echo "$ALL_TAGS" | grep -v '^$' | sort
          
          # ç­›é€‰å¸¦vå‰ç¼€çš„æ•°å­—ç‰ˆæœ¬å· + å»vå‰ç¼€ + æŒ‰è¯­ä¹‰åŒ–æ’åºå–æœ€æ–°
          REMOTE_VERSION=$(echo "$ALL_TAGS" | grep -v '^$' \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sed 's/^v//' \
            | sort -V \
            | tail -n1)
          
          # ç»ˆæå…œåº•
          if [ -z "$REMOTE_VERSION" ] || [ "$REMOTE_VERSION" = "null" ]; then
            echo "âŒ æœªè·å–åˆ°æœ‰æ•ˆç‰ˆæœ¬å·ï¼Œä½¿ç”¨å…œåº•ç‰ˆæœ¬ï¼š4.9.81"
            REMOTE_VERSION="4.9.81"
          fi
          
          # ===================== è·å–é•œåƒå“ˆå¸Œï¼ˆä»å®Œæ•´æ ‡ç­¾æ•°æ®ä¸­åŒ¹é…ï¼‰ =====================
          ORIGINAL_TAG="v${REMOTE_VERSION}"
          echo -e "\nğŸ“Œ æŸ¥æ‰¾åŸå§‹æ ‡ç­¾ ${ORIGINAL_TAG} çš„å“ˆå¸Œ..."
          
          # é‡æ–°è·å–è¯¥æ ‡ç­¾çš„å®Œæ•´æ•°æ®ï¼ˆç¡®ä¿å“ˆå¸Œå‡†ç¡®ï¼‰
          TAG_DETAIL=$(curl -sSL --retry 3 --connect-timeout 15 --max-time 30 \
            -H "Accept: application/json" \
            "${DOCKER_HUB_API}?page_size=100&name=${ORIGINAL_TAG}")
          
          # æå–å“ˆå¸Œ
          REMOTE_DIGEST=$(echo "$TAG_DETAIL" | jq -r --arg tag "$ORIGINAL_TAG" '.results[] | select(.name == $tag) | .digest')
          
          # å¤‡ç”¨ï¼šskopeoè·å–
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ]; then
            echo "âš ï¸ ä»APIæå–å“ˆå¸Œå¤±è´¥ï¼Œå°è¯•ç”¨skopeoè·å–..."
            REMOTE_DIGEST=$(skopeo inspect --format '{{.Digest}}' docker://mlikiowa/napcat-docker:${ORIGINAL_TAG} 2>/dev/null)
          fi
          
          # å“ˆå¸Œå…œåº•
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ] || [ "$REMOTE_DIGEST" = "<no value>" ]; then
            echo "âŒ æœªè·å–åˆ°é•œåƒå“ˆå¸Œï¼Œä½¿ç”¨ç©ºå€¼"
            REMOTE_DIGEST=""
          fi
          
          # ===================== è¾“å‡ºæœ€ç»ˆç»“æœ =====================
          echo -e "\nâœ… æœ€ç»ˆè·å–ç»“æœï¼š"
          echo "   æœ€æ–°ç‰ˆæœ¬å·ï¼ˆå»vå‰ç¼€ï¼‰ï¼š$REMOTE_VERSION"
          echo "   åŸå§‹Dockeræ ‡ç­¾ï¼š$ORIGINAL_TAG"
          echo "   é•œåƒå“ˆå¸Œï¼š$REMOTE_DIGEST"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "arch=Linux-AMD64" >> $GITHUB_OUTPUT

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•ï¼ˆé¿å…ç‰ˆæœ¬å·ç›¸åŒä½†é•œåƒæ›´æ–°ï¼‰
        id: local_digest
        run: |
          if [ -f "docker-image-digest.txt" ]; then
            LOCAL_DIGEST=$(cat docker-image-digest.txt | xargs)
          else
            LOCAL_DIGEST=""
            touch docker-image-digest.txt
          fi
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT
          echo "æœ¬åœ°é•œåƒå“ˆå¸Œï¼š$LOCAL_DIGEST"

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼Œåˆ¤æ–­æ˜¯å¦æ›´æ–°
        id: compare
        run: |
          if [ "${{ steps.local_ver.outputs.local_version }}" = "${{ steps.remote_ver.outputs.remote_version }}" ] && [ "${{ steps.local_digest.outputs.local_digest }}" = "${{ steps.remote_ver.outputs.remote_digest }}" ]; then
            echo "âœ… æœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬+å“ˆå¸Œä¸€è‡´ï¼ˆ${{ steps.remote_ver.outputs.remote_version }}ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´ï¼Œå¼€å§‹æ›´æ–°æ‰“åŒ…æµç¨‹"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…ç‰ˆæœ¬/å“ˆå¸Œä¸ä¸€è‡´æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifestç‰ˆæœ¬å· + å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # æ›´æ–°manifestç‰ˆæœ¬å·ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
          sed -i -E \
            "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?)([0-9a-zA-Z.]+)([\"']?)/\1\2${{ steps.remote_ver.outputs.remote_version }}\4/" \
            fpk-napcatqq/manifest
          
          # æ›´æ–°å“ˆå¸Œè®°å½•
          echo "${{ steps.remote_ver.outputs.remote_digest }}" > docker-image-digest.txt
          
          echo "âœ… manifestç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          cat fpk-napcatqq/manifest | grep -i version
          echo "âœ… é•œåƒå“ˆå¸Œå·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_digest }}"
          cat docker-image-digest.txt

          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/manifest docker-image-digest.txt

      - name: 9. æäº¤å¹¶æ¨é€manifest+å“ˆå¸Œå˜æ›´åˆ°å½“å‰ä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… manifest+å“ˆå¸Œå·²æ¨é€åˆ°å½“å‰ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpackï¼ˆæŒ‡å®šåœ°å€ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack "$FNPACK_URL"
          chmod +x /usr/local/bin/fnpack
          
          if ! command -v fnpack &>/dev/null; then
            echo "âŒ fnpackå®‰è£…å¤±è´¥"
            exit 1
          fi
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(which fnpack)"

      - name: 11. è¿›å…¥napcat-dockerç›®å½•æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          # è¿›å…¥fpk-napcatqqç›®å½•
          cd fpk-napcatqq
          echo "ğŸš€ è¿›å…¥fpk-napcatqqç›®å½•ï¼Œæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼šfnpack build"
          fnpack build
          
          # æŸ¥æ‰¾æ‰“åŒ…åçš„fpkæ–‡ä»¶
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          if [ -z "$FPK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ‰“åŒ…åçš„fpkæ–‡ä»¶"
            exit 1
          fi
          
          # æ‹¼æ¥å®Œæ•´è·¯å¾„
          FPK_FULL_PATH=$(pwd)/$FPK_FILE
          # å›ºå®šåç§°ï¼ˆæ¨FnDepotï¼‰
          FPK_FIXED_NAME="fpk-napcatqq.fpk"
          # å¸¦ç‰ˆæœ¬å·+æ¶æ„åç§°ï¼ˆä¼ Releaseï¼‰
          FPK_VERSION_NAME="fpk-napcatqq-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}.fpk"
          
          # å¤åˆ¶ä¸¤ä»½æ–‡ä»¶
          mv "$FPK_FULL_PATH" /tmp/$FPK_FIXED_NAME
          cp /tmp/$FPK_FIXED_NAME /tmp/$FPK_VERSION_NAME
          
          echo "âœ… fnpackæ‰“åŒ…å®Œæˆï¼š"
          echo "  - å›ºå®šåç§°ï¼š/tmp/$FPK_FIXED_NAME"
          echo "  - ç‰ˆæœ¬+æ¶æ„åç§°ï¼š/tmp/$FPK_VERSION_NAME"
          echo "fpk_file=/tmp/$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_name=$FPK_FIXED_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_file=/tmp/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€fpkåˆ°FnDepotä»“åº“ + æ›´æ–°é…ç½®æ–‡ä»¶ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git clone https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git /tmp/FnDepot
          echo "âœ… æˆåŠŸå…‹éš†FnDepotä»“åº“åˆ°/tmp/FnDepot"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepotç›®æ ‡ç›®å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          # åˆ›å»ºç›®æ ‡æ–‡ä»¶å¤¹
          mkdir -p /tmp/FnDepot/fpk-napcatqq
          
          # åˆ é™¤æ—§æ–‡ä»¶
          rm -f /tmp/FnDepot/fpk-napcatqq/fpk-napcatqq.fpk
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp ${{ steps.build_fpk.outputs.fpk_file }} /tmp/FnDepot/fpk-napcatqq/
          
          echo "âœ… fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š/tmp/FnDepot/fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }}"
          ls -lh /tmp/FnDepot/fpk-napcatqq/

      - name: 14. æ›´æ–°FnDepotçš„fnpack.jsonä¸­napcat-dockerç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºfnpack.json
          if [ ! -f "fnpack.json" ]; then
            echo '{"fpk-napcatqq": {"version": ""}}' > fnpack.json
            echo "âœ… åˆ›å»ºé»˜è®¤çš„fnpack.jsonæ–‡ä»¶"
          fi
          
          # æ›´æ–°ç‰ˆæœ¬å·
          jq --arg ver "${{ steps.remote_ver.outputs.remote_version }}" \
            '.["fpk-napcatqq"].version = $ver' fnpack.json > fnpack.tmp && mv fnpack.tmp fnpack.json
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼Œå½“å‰å†…å®¹ï¼š"
          cat fnpack.json

      - name: 15. æ›´æ–°FnDepotçš„README.mdä¸­napcat-dockerè¡¨æ ¼ç‰ˆæœ¬å·
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æ£€æŸ¥å¹¶åˆ›å»ºREADME.md
          if [ ! -f "README.md" ]; then
            echo "# FnDepot\n\n| **NapCatQQ** | ${{ steps.remote_ver.outputs.remote_version }} | NapCatQQ/https://github.com/NapNeko/NapCatQQ |\n\nNapCatQQæ˜¯é€šè¿‡Github-Actionsè¿›è¡Œæ¯å¤©è‡ªåŠ¨åŒ–æ£€æµ‹æœ€æ–°ç‰ˆæœ¬è¿›è¡Œæ‰“åŒ…æ¨é€åˆ°æœ¬ä»“åº“\nè„šæœ¬è‡ªåŠ¨åŒ–ä»“åº“ï¼šhttps://github.com/moxyis/fpk-napcatqq" > README.md
            echo "âœ… åˆ›å»ºé»˜è®¤çš„README.mdæ–‡ä»¶"
          else
            # ç²¾å‡†æ›´æ–°è¡¨æ ¼ç‰ˆæœ¬å·ï¼ˆå…¼å®¹ä¸åŒé“¾æ¥æ ¼å¼ï¼‰
            sed -i -E \
              "s/(\|\s*\*\*NapCatQQ\*\*\s*\|\s*)[0-9.]+\s*(\|\s*NapCatQQ\/.*\s*\|)/\1${{ steps.remote_ver.outputs.remote_version }}\2/g" \
              README.md
              
            echo "âœ… README.mdä¸­NapCatQQè¡¨æ ¼ç‰ˆæœ¬å·²æ›´æ–°ä¸ºï¼š${{ steps.remote_ver.outputs.remote_version }}"
          fi
          
          # è¾“å‡ºå…³é”®å†…å®¹
          echo "ğŸ“„ æ›´æ–°åçš„README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 1 -B 1 -i "napcat" README.md

      - name: 16. æäº¤å¹¶æ¨é€æ‰€æœ‰å˜æ›´åˆ°FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add fpk-napcatqq/${{ steps.build_fpk.outputs.fpk_name }} fnpack.json README.md
          
          # æäº¤å˜æ›´
          git commit -m "chore: æ›´æ–°napcat-dockerç‰ˆæœ¬è‡³${{ steps.remote_ver.outputs.remote_version }}" || echo "âœ… æ— éœ€è¦æäº¤çš„å˜æ›´"
          
          # æ¨é€å˜æ›´
          git push origin main
          echo "âœ… æ‰€æœ‰å˜æ›´å·²æ¨é€åˆ° https://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq"

      # ===================== ç¬¬äº”æ­¥ï¼šä¸Šä¼ FPKåˆ°å½“å‰ä»“åº“çš„GitHub Releases =====================
      - name: 17. åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ FPKæ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "napcat-docker-v${{ steps.remote_ver.outputs.remote_version }}-${{ steps.remote_ver.outputs.arch }}"
          name: "napcat-docker v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## napcat-docker è‡ªåŠ¨æ‰“åŒ…æ›´æ–°
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - åŸå§‹Dockeræ ‡ç­¾ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - å¹³å°æ¶æ„ï¼š${{ steps.remote_ver.outputs.arch }}
            - æ‰“åŒ…æ ¼å¼ï¼šfpk
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
            - æ‰“åŒ…å·¥å…·ï¼šfnpack 1.0.4
            - é•œåƒå“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest }}
            - æ ‡ç­¾è·å–ï¼šéå†${{ steps.remote_ver.outputs.page_count }}é¡µDocker Hubæ ‡ç­¾
            - FnDepotä»“åº“ï¼šhttps://github.com/moxyis/FnDepot/tree/main/fpk-napcatqq
          prerelease: false
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true  # è¦†ç›–åŒåæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
